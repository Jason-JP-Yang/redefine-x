const e=new WeakSet,r=new Map,t=new Map;let o=null,a=!1,n=[],s=!1,i=!1,c=null;function loadImage(e,r){return new Promise(((t,o)=>{const a=new Image;a.alt=r,function isSameOrigin(e){try{return new URL(e,window.location.href).origin===window.location.origin}catch{return!1}}(e)&&(a.crossOrigin="anonymous"),a.onload=()=>t(a),a.onerror=()=>o(new Error(`Failed to load: ${e}`)),a.src=e}))}async function ensureImageCached(e,o){if(r.has(e))return r.get(e);if(t.has(e))return t.get(e);const a=loadImage(e,o).then((o=>(r.set(e,o),t.delete(e),o))).catch((r=>{throw t.delete(e),r}));return t.set(e,a),a}export async function requestImageBySrc(e,r=""){return function cloneLoadedImage(e,r){const t=e.cloneNode(!1);return t.alt=r||e.alt||"",e.crossOrigin&&(t.crossOrigin=e.crossOrigin),t.src=e.src,t}(await ensureImageCached(e,r),r)}async function processPreloader(r){if(e.has(r))return;e.add(r);const t=r.dataset.src,o=r.dataset.alt||"";try{!function replacePreloader(e,r){Array.from(e.classList).filter((e=>!e.startsWith("img-preloader"))).forEach((e=>r.classList.add(e)));const t=e.dataset.width,o=e.dataset.height;t&&(r.width=parseInt(t,10)),o&&(r.height=parseInt(o,10)),r.classList.add("img-preloader-loaded"),r.dataset.originalSrc=e.dataset.src,e.classList.add("img-preloader-fade-out"),setTimeout((()=>{e.parentNode?.replaceChild(r,e)}),200)}(r,await requestImageBySrc(t,o))}catch(e){console.error("[lazyload]",e),function showError(e,r){e.classList.add("img-preloader-error");const t=e.querySelector(".img-preloader-skeleton");t&&(t.innerHTML=`\n      <i class="fa-solid fa-circle-xmark img-preloader-error-icon"></i>\n      <div class="img-preloader-error-text">\n        <div class="error-message">Failed to load image</div>\n        <div class="error-url">${r}</div>\n      </div>\n    `)}(r,t)}}async function preloadImageToCache(t){const o=t.dataset.src,a=t.dataset.alt||"";if(!r.has(o)&&!e.has(t))try{await ensureImageCached(o,a)}catch(e){console.warn("[lazyload preload]",e)}}function isNetworkIdle(){if("undefined"==typeof performance||!performance.getEntriesByType)return!0;const e=performance.getEntriesByType("resource"),r=performance.now();return 0===e.filter((e=>{const t=e.responseEnd||e.fetchStart;return r-t<500})).length}function buildPreloadQueue(){const r=Array.from(document.querySelectorAll(".img-preloader")).filter((r=>!e.has(r)));if(0===r.length)return[];const t=[],o=[];r.forEach((e=>{const{position:r,distance:a}=function getViewportPosition(e){const r=e.getBoundingClientRect(),t=window.innerHeight;return r.top<0?{position:"above",distance:Math.abs(r.bottom)}:r.top>t?{position:"below",distance:r.top-t}:{position:"visible",distance:0}}(e);"above"===r?t.push({preloader:e,distance:a}):"below"===r&&o.push({preloader:e,distance:a})})),t.sort(((e,r)=>e.distance-r.distance)),o.sort(((e,r)=>e.distance-r.distance));const a=[];return a.push(...o.slice(0,3).map((e=>e.preloader))),a.push(...t.slice(0,3).map((e=>e.preloader))),a.push(...o.slice(3).map((e=>e.preloader))),a.push(...t.slice(3).map((e=>e.preloader))),a}async function processPreloadQueue(){if(!s&&0!==n.length){for(s=!0;n.length>0;){if(i){await new Promise((e=>setTimeout(e,500)));continue}for(;!isNetworkIdle();)await new Promise((e=>setTimeout(e,200)));const e=n.shift();await preloadImageToCache(e),await new Promise((e=>setTimeout(e,100)))}s=!1}}export default function initLazyLoad(e={}){a=!0===e.preload;const r=document.querySelectorAll(".img-preloader:not([data-observed])");if(0===r.length)return;const t=function getObserver(){return o||(o=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(o.unobserve(e.target),processPreloader(e.target))}))}),{rootMargin:"100px",threshold:.01})),o}();r.forEach((e=>{e.dataset.observed="true",t.observe(e)})),a&&(!function startPreload(){a&&setTimeout((()=>{n=buildPreloadQueue(),processPreloadQueue()}),1e3)}(),window.addEventListener("scroll",(()=>{i=!0,clearTimeout(c),c=setTimeout((()=>{i=!1,s||0!==n.length||(n=buildPreloadQueue(),processPreloadQueue())}),500)}),{passive:!0}))}export function forceLoadAllPreloaders(){document.querySelectorAll(".img-preloader").forEach(processPreloader)}
//# sourceMappingURL=lazyload.js.map