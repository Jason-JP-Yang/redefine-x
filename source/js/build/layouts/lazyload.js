export const loadedPreloaders=new WeakSet;const e=new Map,r=new Map;let t=null,o=!1,a=[],n=!1,s=!1,i=null;function loadImage(e,r){return new Promise(((t,o)=>{const a=new Image;a.alt=r,function isSameOrigin(e){try{return new URL(e,window.location.href).origin===window.location.origin}catch{return!1}}(e)&&(a.crossOrigin="anonymous"),a.onload=()=>t(a),a.onerror=()=>o(new Error(`Failed to load: ${e}`)),a.src=e}))}async function ensureImageCached(t,o){if(e.has(t))return e.get(t);if(r.has(t))return r.get(t);const a=loadImage(t,o).then((o=>(e.set(t,o),r.delete(t),o))).catch((e=>{throw r.delete(t),e}));return r.set(t,a),a}export async function requestImageBySrc(r,t=""){const o=await ensureImageCached(r,t);return t&&(o.alt=t),e.get(r)===o&&e.delete(r),o}export function transformPreloaderToImage(e,r){Array.from(e.classList).filter((e=>!e.startsWith("img-preloader"))).forEach((e=>r.classList.add(e)));const t=e.dataset.width,o=e.dataset.height;return t&&(r.width=parseInt(t,10)),o&&(r.height=parseInt(o,10)),r.classList.add("img-preloader-loaded"),r.dataset.originalSrc=e.dataset.src,r}async function processPreloader(e){if(loadedPreloaders.has(e))return;loadedPreloaders.add(e);const r=e.dataset.src,t=e.dataset.alt||"";try{!function replacePreloader(e,r){transformPreloaderToImage(e,r),e.classList.add("img-preloader-fade-out"),setTimeout((()=>{e.parentNode?.replaceChild(r,e),window.dispatchEvent(new CustomEvent("redefine:image-loaded",{detail:{img:r}}))}),200)}(e,await requestImageBySrc(r,t))}catch(t){console.error("[lazyload]",t),function showError(e,r){const t=e.querySelector(".img-preloader-shim");t&&t.remove(),e.classList.add("img-preloader-error"),e.style.width="100%",e.style.height="fit-content",e.style.removeProperty("aspect-ratio"),e.style.removeProperty("max-height"),e.style.removeProperty("max-width"),e.style.removeProperty("margin");const o=e.querySelector(".img-preloader-skeleton");o&&(o.innerHTML=`\n      <i class="fa-solid fa-circle-xmark img-preloader-error-icon"></i>\n      <div class="img-preloader-error-text">\n        <div class="error-message">Failed to load image</div>\n        <div class="error-url">${r}</div>\n      </div>\n    `),window.dispatchEvent(new CustomEvent("redefine:force-exif-check"))}(e,r)}}async function preloadImageToCache(r){const t=r.dataset.src,o=r.dataset.alt||"";if(!e.has(t)&&!loadedPreloaders.has(r))try{await ensureImageCached(t,o)}catch(e){console.warn("[lazyload preload]",e)}}function isNetworkIdle(){if("undefined"==typeof performance||!performance.getEntriesByType)return!0;const e=performance.getEntriesByType("resource"),r=performance.now();return 0===e.filter((e=>{const t=e.responseEnd||e.fetchStart;return r-t<500})).length}function buildPreloadQueue(){const e=Array.from(document.querySelectorAll(".img-preloader")).filter((e=>!loadedPreloaders.has(e)));if(0===e.length)return[];const r=[],t=[];e.forEach((e=>{const{position:o,distance:a}=function getViewportPosition(e){const r=e.getBoundingClientRect(),t=window.innerHeight;return r.top<0?{position:"above",distance:Math.abs(r.bottom)}:r.top>t?{position:"below",distance:r.top-t}:{position:"visible",distance:0}}(e);"above"===o?r.push({preloader:e,distance:a}):"below"===o&&t.push({preloader:e,distance:a})})),r.sort(((e,r)=>e.distance-r.distance)),t.sort(((e,r)=>e.distance-r.distance));const o=[];return o.push(...t.slice(0,3).map((e=>e.preloader))),o.push(...r.slice(0,3).map((e=>e.preloader))),o.push(...t.slice(3).map((e=>e.preloader))),o.push(...r.slice(3).map((e=>e.preloader))),o}async function processPreloadQueue(){if(!n&&0!==a.length){for(n=!0;a.length>0;){if(s){await new Promise((e=>setTimeout(e,500)));continue}for(;!isNetworkIdle();)await new Promise((e=>setTimeout(e,200)));const e=a.shift();await preloadImageToCache(e),await new Promise((e=>setTimeout(e,100)))}n=!1}}export default function initLazyLoad(e={}){o=!0===e.preload;const r=document.querySelectorAll(".img-preloader:not([data-observed])");if(0===r.length)return;const d=function getObserver(){return t||(t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(t.unobserve(e.target),processPreloader(e.target))}))}),{rootMargin:"100px",threshold:.01})),t}();r.forEach((e=>{e.dataset.observed="true",d.observe(e)})),o&&(!function startPreload(){o&&setTimeout((()=>{a=buildPreloadQueue(),processPreloadQueue()}),1e3)}(),window.addEventListener("scroll",(()=>{s=!0,clearTimeout(i),i=setTimeout((()=>{s=!1,n||0!==a.length||(a=buildPreloadQueue(),processPreloadQueue())}),500)}),{passive:!0}))}export function forceLoadAllPreloaders(){document.querySelectorAll(".img-preloader").forEach(processPreloader)}
//# sourceMappingURL=lazyload.js.map