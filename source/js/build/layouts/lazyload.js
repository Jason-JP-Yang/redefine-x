const e=new WeakSet,r=new Map;let t=null,o=!1,a=[],n=!1,s=!1,i=null;function loadImage(e,r){return new Promise(((t,o)=>{const a=new Image;a.alt=r,function isSameOrigin(e){try{return new URL(e,window.location.href).origin===window.location.origin}catch{return!1}}(e)&&(a.crossOrigin="anonymous"),a.onload=()=>t(a),a.onerror=()=>o(new Error(`Failed to load: ${e}`)),a.src=e}))}async function processPreloader(t){if(e.has(t))return;e.add(t);const o=t.dataset.src,a=t.dataset.alt||"";try{let e=r.get(o);e||(e=await loadImage(o,a)),function replacePreloader(e,r){Array.from(e.classList).filter((e=>!e.startsWith("img-preloader"))).forEach((e=>r.classList.add(e)));const t=e.dataset.width,o=e.dataset.height;t&&(r.width=parseInt(t,10)),o&&(r.height=parseInt(o,10)),r.classList.add("img-preloader-loaded"),r.dataset.originalSrc=e.dataset.src,e.classList.add("img-preloader-fade-out"),setTimeout((()=>{e.parentNode?.replaceChild(r,e)}),200)}(t,e)}catch(e){console.error("[lazyload]",e),function showError(e,r){e.classList.add("img-preloader-error");const t=e.querySelector(".img-preloader-skeleton");t&&(t.innerHTML=`\n      <i class="fa-solid fa-circle-xmark img-preloader-error-icon"></i>\n      <div class="img-preloader-error-text">\n        <div class="error-message">Failed to load image</div>\n        <div class="error-url">${r}</div>\n      </div>\n    `)}(t,o)}}async function preloadImageToCache(t){const o=t.dataset.src,a=t.dataset.alt||"";if(!r.has(o)&&!e.has(t))try{const e=await loadImage(o,a);r.set(o,e)}catch(e){console.warn("[lazyload preload]",e)}}function isNetworkIdle(){if("undefined"==typeof performance||!performance.getEntriesByType)return!0;const e=performance.getEntriesByType("resource"),r=performance.now();return 0===e.filter((e=>{const t=e.responseEnd||e.fetchStart;return r-t<500})).length}function buildPreloadQueue(){const r=Array.from(document.querySelectorAll(".img-preloader")).filter((r=>!e.has(r)));if(0===r.length)return[];const t=[],o=[];r.forEach((e=>{const{position:r,distance:a}=function getViewportPosition(e){const r=e.getBoundingClientRect(),t=window.innerHeight;return r.top<0?{position:"above",distance:Math.abs(r.bottom)}:r.top>t?{position:"below",distance:r.top-t}:{position:"visible",distance:0}}(e);"above"===r?t.push({preloader:e,distance:a}):"below"===r&&o.push({preloader:e,distance:a})})),t.sort(((e,r)=>e.distance-r.distance)),o.sort(((e,r)=>e.distance-r.distance));const a=[];return a.push(...o.slice(0,3).map((e=>e.preloader))),a.push(...t.slice(0,3).map((e=>e.preloader))),a.push(...o.slice(3).map((e=>e.preloader))),a.push(...t.slice(3).map((e=>e.preloader))),a}async function processPreloadQueue(){if(!n&&0!==a.length){for(n=!0;a.length>0;){if(s){await new Promise((e=>setTimeout(e,500)));continue}for(;!isNetworkIdle();)await new Promise((e=>setTimeout(e,200)));const e=a.shift();await preloadImageToCache(e),await new Promise((e=>setTimeout(e,100)))}n=!1}}export default function initLazyLoad(e={}){o=!0===e.preload;const r=document.querySelectorAll(".img-preloader:not([data-observed])");if(0===r.length)return;const l=function getObserver(){return t||(t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(t.unobserve(e.target),processPreloader(e.target))}))}),{rootMargin:"100px",threshold:.01})),t}();r.forEach((e=>{e.dataset.observed="true",l.observe(e)})),o&&(!function startPreload(){o&&setTimeout((()=>{a=buildPreloadQueue(),processPreloadQueue()}),1e3)}(),window.addEventListener("scroll",(()=>{s=!0,clearTimeout(i),i=setTimeout((()=>{s=!1,n||0!==a.length||(a=buildPreloadQueue(),processPreloadQueue())}),500)}),{passive:!0}))}export function forceLoadAllPreloaders(){document.querySelectorAll(".img-preloader").forEach(processPreloader)}
//# sourceMappingURL=lazyload.js.map