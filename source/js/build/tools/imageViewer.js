export default function imageViewer(){const e=window.__REDEFINE_X_IMAGE_VIEWER__||(window.__REDEFINE_X_IMAGE_VIEWER__={docBound:!1,maskEl:null,stageEl:null,handlers:{},api:null}),t=document.querySelector(".image-viewer-container"),n=t?.querySelector(".image-viewer-stage");if(!t||!n)return;const i=".markdown-body img, .masonry-item img, #shuoshuo-content img",a="cubic-bezier(0.22, 1, 0.36, 1)",o={padding:"2px",backgroundColor:"var(--background-color)",boxShadow:"0 18px 60px rgba(0, 0, 0, 0.35)"},nextFrame=()=>new Promise((e=>requestAnimationFrame((()=>e())))),r=".right-side-tools-container, .aplayer.aplayer-fixed";let s=null;const isViewableImg=e=>e&&!e.closest(".image-viewer-container")&&e.complete&&e.naturalWidth&&!e.hasAttribute("data-no-viewer"),l={isOpen:!1,isAnimating:!1,currentIndex:-1,items:[],activeImg:null,placeholder:null,saved:null,scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,pointers:new Map,pinchStart:null,fixedHidden:!1},applyTransform=()=>l.activeImg&&(l.activeImg.style.transform=`translate(${l.translateX}px, ${l.translateY}px) scale(${l.scale})`),constrainVisible=()=>{if(!l.activeImg)return;const e=n.getBoundingClientRect(),t=l.activeImg.getBoundingClientRect(),i=.1*t.width,a=.1*t.height;t.right<e.left+i?l.translateX+=e.left+i-t.right:t.left>e.right-i&&(l.translateX+=e.right-i-t.left),t.bottom<e.top+a?l.translateY+=e.top+a-t.bottom:t.top>e.bottom-a&&(l.translateY+=e.bottom-a-t.top),applyTransform()},animateFlight=async(e,t,n,i)=>(await nextFrame(),await nextFrame(),e.style.transition=[`transform ${t}ms ${a}`,`box-shadow ${t}ms ${a}`,`background-color ${t}ms ${a}`,`padding ${t}ms ${a}`,`border-radius ${t}ms ${a}`].join(", "),e.style.transform="translate(0, 0) scale(1, 1)",n&&(null!=n.padding&&(e.style.padding=n.padding),null!=n.backgroundColor&&(e.style.backgroundColor=n.backgroundColor),null!=n.boxShadow&&(e.style.boxShadow=n.boxShadow)),null!=i&&(e.style.borderRadius=i),new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))),clearFlightStyles=(e,t)=>{const n=["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","animation"];t||n.push("borderRadius","boxSizing","padding","backgroundColor","boxShadow"),n.forEach((t=>e.style[t]=""))},onKeydown=e=>{l.isOpen&&("Escape"===e.key?close():"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key&&navigate(1))};async function open(e){if(l.isOpen||l.isAnimating)return;l.isOpen=l.isAnimating=!0,l.items=Array.from(document.querySelectorAll(i)).filter((e=>e instanceof HTMLImageElement&&isViewableImg(e))),l.currentIndex=l.items.indexOf(e),l.currentIndex<0&&(l.items=[e],l.currentIndex=0),l.saved=(e=>{const t=getComputedStyle(e),n=(e=>{const t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}})(e);return{parent:e.parentNode,nextSibling:e.nextSibling,styleAttr:e.getAttribute("style"),borderRadius:t.borderRadius,padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,rect:n}})(e),l.scale=1,l.translateX=l.translateY=0,l.pointers.clear(),l.pinchStart=null,l.isDragging=!1,l.placeholder=(e=>{const t=document.createElement("span");t.className="image-viewer-placeholder";const n=getComputedStyle(e),i=(e.naturalWidth||1)/(e.naturalHeight||1);return t.style.cssText=`\n      display:${n.display};\n      width:${n.width};\n      max-width:${n.maxWidth};\n      aspect-ratio:${i};\n      margin:${n.margin};\n      padding:0;\n      border:none;\n      visibility:hidden;\n      box-sizing:border-box;\n    `,t})(e,l.saved),e.before(l.placeholder);const a=(e=>{const t=window.innerWidth,n=window.innerHeight,i=.92*t-4,a=.92*n-4,o=(e.naturalWidth||1)/(e.naturalHeight||1);let r=i,s=r/o;s>a&&(s=a,r=s*o);const l=r+4,d=s+4;return{left:(t-l)/2,top:(n-d)/2,width:l,height:d}})(e);document.documentElement.style.overflow="hidden",l.fixedHidden=window.matchMedia&&window.matchMedia("(max-width: 768px), (pointer: coarse)").matches,l.fixedHidden&&(s&&(clearTimeout(s),s=null),document.querySelectorAll(r).forEach((e=>{e.classList.add("hide")}))),n.innerHTML="",t.style.zIndex="",t.classList.add("active"),((e,t,n,i,a,o,r)=>{const s=n.left-t.left,l=n.top-t.top,d=n.width/t.width,c=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${a||"0"};\n      box-sizing:border-box;\n      padding:${i?.padding??"0"};\n      background-color:${i?.backgroundColor??"transparent"};\n      box-shadow:${i?.boxShadow??"none"};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${r};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),o.appendChild(e)})(e,a,l.saved.rect,{padding:l.saved.padding,backgroundColor:l.saved.backgroundColor,boxShadow:l.saved.boxShadow},l.saved.borderRadius,document.body,1009),await animateFlight(e,420,o,l.saved.borderRadius),clearFlightStyles(e,!0),n.appendChild(e),l.activeImg=e,e.style.cursor="grab",e.style.touchAction="none",e.style.width="",e.style.height="",applyTransform(),constrainVisible(),l.isAnimating=!1,document.addEventListener("keydown",onKeydown)}async function close(){if(!l.isOpen||l.isAnimating)return;if(!l.activeImg||!l.placeholder)return;l.isAnimating=!0,document.removeEventListener("keydown",onKeydown);const e=l.activeImg,i=l.placeholder,a=getComputedStyle(e),o=e.getBoundingClientRect(),d=i.getBoundingClientRect(),c=d.left,g=d.top,p=d.width,m=d.height,h=o.left-c,u=o.top-g,x=o.width/p,v=o.height/m,w={padding:l.saved?.padding??"0",backgroundColor:l.saved?.backgroundColor??"transparent",boxShadow:l.saved?.boxShadow??"none"};t.style.zIndex=String(1003),e.style.cssText=`\n      position:fixed;\n      left:${c}px;\n      top:${g}px;\n      width:${p}px;\n      height:${m}px;\n      border-radius:${a.borderRadius};\n      box-sizing:border-box;\n      padding:${a.padding};\n      background-color:${a.backgroundColor};\n      box-shadow:${a.boxShadow};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:1004;\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${h}px, ${u}px) scale(${x}, ${v});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),document.body.appendChild(e),n.innerHTML="",t.classList.remove("active"),await animateFlight(e,360,w,l.saved?.borderRadius),clearFlightStyles(e,!1),(e=>{l.saved&&(null==l.saved.styleAttr?e.removeAttribute("style"):e.setAttribute("style",l.saved.styleAttr),e.classList.remove("img-preloader-loaded"),e.style.animation="")})(e),i.replaceWith(e),document.documentElement.style.overflow="",l.fixedHidden&&(((e=300)=>{s=setTimeout((()=>{document.querySelectorAll(r).forEach((e=>{e.classList.remove("hide")})),s=null}),e)})(300),l.fixedHidden=!1),l.activeImg=l.placeholder=l.saved=null,l.pointers.clear(),l.pinchStart=null,l.isOpen=l.isAnimating=!1,t.style.zIndex=""}async function navigate(e){if(!l.isOpen||l.items.length<=1||l.isAnimating)return;const t=(l.currentIndex+e+l.items.length)%l.items.length,n=l.items[t];n&&isViewableImg(n)&&(l.currentIndex=t,await close(),await nextFrame(),await open(n))}if(e.api={open:open,close:close,isOpen:()=>l.isOpen},e.docBound||(e.handlers.onDocClick=t=>{const n=e.api;if(!n||n.isOpen())return;const a=t.target;a instanceof HTMLImageElement&&a.matches(i)&&isViewableImg(a)&&n.open(a)},document.addEventListener("click",e.handlers.onDocClick,!0),e.docBound=!0),e.maskEl!==t&&(e.maskEl&&e.handlers.onMaskClick&&e.maskEl.removeEventListener("click",e.handlers.onMaskClick,!1),e.handlers.onMaskClick=e=>{l.isOpen&&!l.isDragging&&(e.target!==t&&e.target!==n||close())},t.addEventListener("click",e.handlers.onMaskClick,!1),e.maskEl=t),e.stageEl!==n){const t=e.stageEl;t&&["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((n=>{const i=e.handlers[`on${n}`];i&&t.removeEventListener(n,i,!1)})),e.handlers.onwheel=e=>{if(!l.isOpen||!l.activeImg||e.target!==l.activeImg)return;e.preventDefault();const t=l.activeImg.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2,a=l.scale;l.scale=Math.max(.5,Math.min(6,a*(e.deltaY>0?.9:1.1)));const o=l.scale/a-1;l.translateX-=n*o,l.translateY-=i*o,l.activeImg.style.transition="none",applyTransform(),constrainVisible()},e.handlers.onpointerdown=e=>{l.isOpen&&l.activeImg&&e.target===l.activeImg&&(e.preventDefault(),l.activeImg.setPointerCapture(e.pointerId),l.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===l.pointers.size&&(l.dragStartX=e.clientX-l.translateX,l.dragStartY=e.clientY-l.translateY,l.activeImg.style.cursor="grabbing",l.activeImg.style.transition="none"))},e.handlers.onpointermove=e=>{if(l.isOpen&&l.activeImg&&l.pointers.has(e.pointerId)){if(l.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===l.pointers.size)return l.translateX=e.clientX-l.dragStartX,l.translateY=e.clientY-l.dragStartY,l.isDragging=!0,applyTransform(),void constrainVisible();if(2===l.pointers.size){const e=Array.from(l.pointers.values()),t=Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y),n=(e[0].x+e[1].x)/2,i=(e[0].y+e[1].y)/2;l.pinchStart||(l.pinchStart={dist:t,midX:n,midY:i,scale:l.scale,tx:l.translateX,ty:l.translateY});const a=Math.max(.5,Math.min(6,l.pinchStart.scale*(t/l.pinchStart.dist))),o=a/l.scale,r=l.activeImg.getBoundingClientRect(),s=n-(r.left+r.width/2),d=i-(r.top+r.height/2);l.translateX-=s*(o-1),l.translateY-=d*(o-1),l.scale=a,l.isDragging=!0,applyTransform(),constrainVisible()}}},e.handlers.onpointerup=e.handlers.onpointercancel=e=>{if(l.isOpen&&l.activeImg)if(l.pointers.delete(e.pointerId),0===l.pointers.size)l.activeImg.style.cursor="grab",l.pinchStart=null,constrainVisible(),setTimeout((()=>l.isDragging=!1),50);else if(1===l.pointers.size){l.pinchStart=null;const e=Array.from(l.pointers.values())[0];l.dragStartX=e.x-l.translateX,l.dragStartY=e.y-l.translateY}},["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((t=>{n.addEventListener(t,e.handlers[`on${t}`],{passive:!1})})),e.stageEl=n}}
//# sourceMappingURL=imageViewer.js.map