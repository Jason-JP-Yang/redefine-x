import{requestImageBySrc as e}from"../layouts/lazyload.js";export default function imageViewer(){const t=window.__REDEFINE_X_IMAGE_VIEWER__||(window.__REDEFINE_X_IMAGE_VIEWER__={docBound:!1,maskEl:null,stageEl:null,handlers:{},api:null}),n=document.querySelector(".image-viewer-container"),i=n?.querySelector(".image-viewer-stage"),a=n?.querySelector(".image-viewer-switcher"),r=a?.querySelector(".image-viewer-switcher-pages"),o=a?.querySelector(".image-viewer-switcher-btn.prev"),s=a?.querySelector(".image-viewer-switcher-btn.next"),l=n?.querySelector(".image-viewer-switcher-side.prev"),d=n?.querySelector(".image-viewer-switcher-side.next");if(!(n&&i&&a&&r&&o&&s&&l&&d))return;const c=360,h="cubic-bezier(0.22, 1, 0.36, 1)",m={padding:"2px",backgroundColor:"var(--background-color)",boxShadow:"0 18px 60px rgba(0, 0, 0, 0.35)"},nextFrame=()=>new Promise((e=>requestAnimationFrame((()=>e())))),g=".right-side-tools-container, .aplayer.aplayer-fixed";let p=null;const isViewableImg=e=>e&&!e.closest(".image-viewer-container")&&!e.hasAttribute("data-no-viewer"),isViewablePreloader=e=>e&&!e.closest(".image-viewer-container")&&e.classList.contains("img-preloader"),toAbsUrl=e=>{try{return new URL(e,window.location.href).href}catch{return String(e||"")}},u={isOpen:!1,isAnimating:!1,currentIndex:-1,items:[],contextRoot:null,activeImg:null,activeEl:null,articleOriginalNode:null,placeholder:null,saved:null,switcherShowTimer:null,scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,pointers:new Map,pinchStart:null,fixedHidden:!1},applyTransform=()=>u.activeImg&&(u.activeImg.style.transform=`translate(${u.translateX}px, ${u.translateY}px) scale(${u.scale})`),constrainVisible=()=>{if(!u.activeImg)return;const e=i.getBoundingClientRect(),t=u.activeImg.getBoundingClientRect(),n=.1*t.width,a=.1*t.height;t.right<e.left+n?u.translateX+=e.left+n-t.right:t.left>e.right-n&&(u.translateX+=e.right-n-t.left),t.bottom<e.top+a?u.translateY+=e.top+a-t.bottom:t.top>e.bottom-a&&(u.translateY+=e.bottom-a-t.top),applyTransform()},computeViewerRect=e=>{const t=window.innerWidth,n=window.innerHeight,i=.92*t-4,a=.92*n-4,r=(e.naturalWidth||1)/(e.naturalHeight||1);let o=i,s=o/r;s>a&&(s=a,o=s*r);const l=o+4,d=s+4;return{left:(t-l)/2,top:(n-d)/2,width:l,height:d}},saveOriginal=e=>{const t=getComputedStyle(e),n=(e=>{const t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}})(e);return{parent:e.parentNode,nextSibling:e.nextSibling,styleAttr:e.getAttribute("style"),borderRadius:t.borderRadius,padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,rect:n}},restoreOriginal=(e,t)=>{const n=t||u.saved;n&&(null==n.styleAttr?e.removeAttribute("style"):e.setAttribute("style",n.styleAttr),e.classList.remove("img-preloader-loaded"),e.style.animation="")},w=1009,f=1003,setFlightStyles=(e,t,n,i,a,r,o)=>{const s=n.left-t.left,l=n.top-t.top,d=n.width/t.width,c=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${a||"0"};\n      box-sizing:border-box;\n      padding:${i?.padding??"0"};\n      background-color:${i?.backgroundColor??"transparent"};\n      box-shadow:${i?.boxShadow??"none"};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${o};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),r.appendChild(e)},animateFlight=async(e,t,n,i)=>(await nextFrame(),await nextFrame(),e.style.transition=[`transform ${t}ms ${h}`,`box-shadow ${t}ms ${h}`,`background-color ${t}ms ${h}`,`padding ${t}ms ${h}`,`border-radius ${t}ms ${h}`].join(", "),e.style.transform="translate(0, 0) scale(1, 1)",n&&(null!=n.padding&&(e.style.padding=n.padding),null!=n.backgroundColor&&(e.style.backgroundColor=n.backgroundColor),null!=n.boxShadow&&(e.style.boxShadow=n.boxShadow)),null!=i&&(e.style.borderRadius=i),new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))),clearFlightStyles=(e,t)=>{const n=["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","animation"];t||n.push("borderRadius","boxSizing","padding","backgroundColor","boxShadow"),n.forEach((t=>e.style[t]=""))},computeViewerRectFromAspect=e=>{const t=window.innerWidth,n=window.innerHeight,i=.92*t-4,a=.92*n-4,r=Number.isFinite(e)&&e>0?e:1;let o=i,s=o/r;s>a&&(s=a,o=s*r);const l=o+4,d=s+4;return{left:(t-l)/2,top:(n-d)/2,width:l,height:d}},getNodeAspectRatio=(e,t)=>{if(t&&t.width>0&&t.height>0)return t.width/t.height;if(e instanceof HTMLImageElement&&e.naturalWidth&&e.naturalHeight)return e.naturalWidth/e.naturalHeight;const n=e?.getBoundingClientRect?.();return n&&n.width>0&&n.height>0?n.width/n.height:1},createPlaceholderForNode=(e,t)=>{const n=document.createElement("span");n.className="image-viewer-placeholder";const i=getComputedStyle(e);return n.style.cssText=`\n      display:${i.display};\n      width:${i.width};\n      max-width:${i.maxWidth};\n      max-height:${i.maxHeight};\n      height:auto;\n      aspect-ratio:${t};\n      margin:${i.margin};\n      padding:0;\n      border:none;\n      visibility:hidden;\n      box-sizing:border-box;\n    `,n},createStagePreloader=(e,t)=>{const n=document.createElement("div");return n.className="img-preloader image-viewer-img-preloader",n.dataset.src="",n.dataset.width="0",n.dataset.height="0",n.style.width=`${e.width}px`,n.style.height=`${e.height}px`,n.style.aspectRatio=`${t}`,n.innerHTML='<div class="img-preloader-skeleton"></div>',n},waitForImageReady=e=>new Promise(((t,n)=>{if(e.complete&&e.naturalWidth)return t(e);const onLoad=()=>cleanup(t,e),onErr=()=>cleanup(n,new Error("Image failed to load")),cleanup=(t,n)=>{e.removeEventListener("load",onLoad),e.removeEventListener("error",onErr),t(n)};e.addEventListener("load",onLoad),e.addEventListener("error",onErr)})),setGenericFlightStyles=(e,t,n,i)=>{const a=n.left-t.left,r=n.top-t.top,o=n.width/t.width,s=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${i};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${a}px, ${r}px) scale(${o}, ${s});\n      opacity:1;\n      animation:none;\n    `,document.body.appendChild(e)},clearFixedStyles=e=>{["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","opacity","animation","boxSizing","padding","backgroundColor","boxShadow","borderRadius"].forEach((t=>{e.style[t]=""}))},onKeydown=e=>{u.isOpen&&("Escape"===e.key?close():"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key&&navigate(1))},getLiveNodeForItem=e=>{if(!u.contextRoot)return e.node;if("preloader"===e.kind){return Array.from(u.contextRoot.querySelectorAll(".img-preloader")).find((t=>toAbsUrl(t.dataset.src)===e.absSrc))||e.node}return Array.from(u.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc))||e.node},updateSwitcherActive=()=>{Array.from(r.children).forEach((e=>{if(!(e instanceof HTMLElement))return;const t=Number(e.dataset.index||"-1");e.classList.toggle("active",t===u.currentIndex)}));const e=r.querySelector(`.image-viewer-switcher-page[data-index="${u.currentIndex}"]`);e?.scrollIntoView?.({block:"nearest",inline:"center"})},hideSwitcher=()=>{u.switcherShowTimer&&(clearTimeout(u.switcherShowTimer),u.switcherShowTimer=null),a.classList.remove("shown"),l.classList.remove("shown"),d.classList.remove("shown")},scheduleShowSwitcher=()=>{u.switcherShowTimer&&clearTimeout(u.switcherShowTimer),u.switcherShowTimer=setTimeout((()=>{u.switcherShowTimer=null,u.isOpen&&!u.isAnimating&&(a.classList.add("shown"),l.classList.add("shown"),d.classList.add("shown"))}),300)},mountLoadedImgToStage=e=>{i.innerHTML="",i.appendChild(e),u.activeImg=e,u.activeEl=e,e.style.cursor="grab",e.style.touchAction="none",e.style.width="",e.style.height="",applyTransform(),constrainVisible()},mountPreloaderToStage=e=>{i.innerHTML="",i.appendChild(e),u.activeImg=null,u.activeEl=e},openItemAtIndex=async(t,n)=>{const a=u.items[t];if(!a)return;const r=getLiveNodeForItem(a),o=getNodeAspectRatio(r,a),s=r instanceof HTMLImageElement&&r.naturalWidth&&r.naturalHeight?computeViewerRect(r):computeViewerRectFromAspect(o);if(u.scale=1,u.translateX=u.translateY=0,u.pointers.clear(),u.pinchStart=null,u.isDragging=!1,r instanceof HTMLImageElement){if(u.saved=saveOriginal(r),u.articleOriginalNode=r,u.placeholder=createPlaceholderForNode(r,o),r.before(u.placeholder),setFlightStyles(r,s,u.saved.rect,{padding:u.saved.padding,backgroundColor:u.saved.backgroundColor,boxShadow:u.saved.boxShadow},u.saved.borderRadius,document.body,w),await animateFlight(r,420,m,u.saved.borderRadius),clearFlightStyles(r,!0),mountLoadedImgToStage(r),!r.complete||!r.naturalWidth){const e=createStagePreloader(s,o);i.insertBefore(e,r),r.style.opacity="0",waitForImageReady(r).then((()=>{r.style.transition=`opacity 220ms ${h}`,r.style.opacity="1",e.classList.add("img-preloader-fade-out"),setTimeout((()=>e.remove()),220)})).catch((()=>{e.classList.add("img-preloader-error")}))}}else if(r instanceof HTMLElement&&r.classList.contains("img-preloader")){const t=r.getBoundingClientRect();u.articleOriginalNode=r,u.saved={rect:{left:t.left,top:t.top,width:t.width,height:t.height}},u.placeholder=createPlaceholderForNode(r,o),r.replaceWith(u.placeholder);const n=r.cloneNode(!0);n.classList.add("image-viewer-img-preloader"),n.style.width=`${s.width}px`,n.style.height=`${s.height}px`,n.style.aspectRatio=`${o}`,setGenericFlightStyles(n,s,u.saved.rect,w),await(async(e,t)=>(await nextFrame(),await nextFrame(),e.style.transition=`transform ${t}ms ${h}, opacity ${t}ms ${h}`,e.style.transform="translate(0, 0) scale(1, 1)",new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))))(n,420),clearFixedStyles(n),mountPreloaderToStage(n),e(a.src,a.alt).then((e=>{u.isOpen&&(e.classList.add("img-preloader-loaded"),mountLoadedImgToStage(e))})).catch((()=>{n.classList.add("img-preloader-error")}))}};async function close(){if(!u.isOpen||u.isAnimating)return;if(!u.activeEl||!u.placeholder)return;u.isAnimating=!0,document.removeEventListener("keydown",onKeydown),hideSwitcher(),n.classList.remove("switching");const e=u.activeEl,t=u.placeholder;if(u.articleOriginalNode instanceof HTMLImageElement&&e===u.articleOriginalNode){const a=e,r=getComputedStyle(a),o=a.getBoundingClientRect(),s=t.getBoundingClientRect(),l={left:s.left,top:s.top,width:s.width,height:s.height},d=o.left-l.left,h=o.top-l.top,m=o.width/l.width,g=o.height/l.height,p={padding:u.saved?.padding??"0",backgroundColor:u.saved?.backgroundColor??"transparent",boxShadow:u.saved?.boxShadow??"none"};n.style.zIndex=String(f),a.style.cssText=`\n        position:fixed;\n        left:${l.left}px;\n        top:${l.top}px;\n        width:${l.width}px;\n        height:${l.height}px;\n        border-radius:${r.borderRadius};\n        box-sizing:border-box;\n        padding:${r.padding};\n        background-color:${r.backgroundColor};\n        box-shadow:${r.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${d}px, ${h}px) scale(${m}, ${g});\n        animation:none;\n      `,a.classList.remove("img-preloader-loaded"),document.body.appendChild(a),i.innerHTML="",n.classList.remove("active"),await animateFlight(a,c,p,u.saved?.borderRadius),clearFlightStyles(a,!1),restoreOriginal(a,u.saved),t.replaceWith(a)}else{const a=e.getBoundingClientRect(),r=t.getBoundingClientRect(),o={left:r.left,top:r.top,width:r.width,height:r.height},s=a.left-o.left,l=a.top-o.top,d=a.width/o.width,c=a.height/o.height;n.style.zIndex=String(f);const m=getComputedStyle(e);e.style.cssText=`\n        position:fixed;\n        left:${o.left}px;\n        top:${o.top}px;\n        width:${o.width}px;\n        height:${o.height}px;\n        border-radius:${m.borderRadius};\n        box-sizing:border-box;\n        padding:${m.padding};\n        background-color:${m.backgroundColor};\n        box-shadow:${m.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n        opacity:1;\n        animation:none;\n      `,document.body.appendChild(e),i.innerHTML="",n.classList.remove("active"),await nextFrame(),await nextFrame(),e.style.transition=`transform 360ms ${h}, opacity 360ms ${h}`,e.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,440))),e.remove(),u.articleOriginalNode instanceof HTMLElement&&t.replaceWith(u.articleOriginalNode)}document.documentElement.style.overflow="",u.fixedHidden&&(((e=300)=>{p=setTimeout((()=>{document.querySelectorAll(g).forEach((e=>{e.classList.remove("hide")})),p=null}),e)})(300),u.fixedHidden=!1),u.activeImg=u.activeEl=null,u.articleOriginalNode=null,u.placeholder=null,u.saved=null,u.pointers.clear(),u.pinchStart=null,u.isOpen=u.isAnimating=!1,n.style.zIndex=""}async function navigate(e){if(!u.isOpen||u.items.length<=1||u.isAnimating)return;const t=(u.currentIndex+e+u.items.length)%u.items.length;await switchToIndex(t)}async function switchToIndex(t){if(!u.isOpen||u.isAnimating)return;if(t===u.currentIndex)return;const a=u.items[t];if(!a)return;const r=t>u.currentIndex?-1:1,o=420,s=Math.round(210);u.isAnimating=!0,hideSwitcher(),n.classList.add("switching");const l=u.activeEl,d=u.placeholder,c=u.articleOriginalNode,g=u.saved,p=l.getBoundingClientRect();i.innerHTML="",((e,t,n)=>{const i=getComputedStyle(e);e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${i.borderRadius};\n      box-sizing:border-box;\n      padding:${i.padding};\n      background-color:${i.backgroundColor};\n      box-shadow:${i.boxShadow};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${n};\n      pointer-events:none;\n      transform-origin:center;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(0, 0) scale(1, 1);\n      opacity:1;\n      animation:none;\n    `})(l,p,w),document.body.appendChild(l);const f=window.innerWidth,x=window.innerHeight/2-(p.top+p.height/2),y=r<0?-(p.left+p.width+40):f-p.left+40;await nextFrame(),await nextFrame(),l.style.transition=`transform 420ms ${h}, opacity 420ms ${h}`,l.style.transform=`translate(${y}px, ${x}px) scale(0.6, 0.6)`,l.style.opacity="0",setTimeout((async()=>{if(!u.isOpen)return;u.currentIndex=t,updateSwitcherActive();const n=getLiveNodeForItem(a),o=getNodeAspectRatio(n,a),s=n instanceof HTMLImageElement&&n.naturalWidth&&n.naturalHeight?computeViewerRect(n):computeViewerRectFromAspect(o);let l;if(u.scale=1,u.translateX=u.translateY=0,u.pointers.clear(),u.pinchStart=null,u.isDragging=!1,n instanceof HTMLImageElement){if(n.complete&&n.naturalWidth){const e=n.getBoundingClientRect(),t=n.cloneNode(!1);t instanceof HTMLImageElement&&(t.classList.add("image-viewer-article-fade-out"),t.src=n.currentSrc||n.src,t.style.cssText=`\n              position:fixed;\n              left:${e.left}px;\n              top:${e.top}px;\n              width:${e.width}px;\n              height:${e.height}px;\n              margin:0;\n              z-index:1003;\n              pointer-events:none;\n            `,document.body.appendChild(t),setTimeout((()=>t.remove()),260))}if(u.saved=saveOriginal(n),u.articleOriginalNode=n,u.placeholder=createPlaceholderForNode(n,o),n.before(u.placeholder),l=n,setFlightStyles(l,s,s,m,u.saved.borderRadius,document.body,w),l.style.transform=r<0?`translate(${f-s.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(s.left+s.width+40)}px, 0px) scale(0.6, 0.6)`,l.style.opacity="0",await nextFrame(),l.style.transition=`transform 420ms ${h}, opacity 420ms ${h}`,l.style.opacity="1",l.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFlightStyles(l,!0),mountLoadedImgToStage(l),!l.complete||!l.naturalWidth){const e=createStagePreloader(s,o);i.insertBefore(e,l),l.style.opacity="0",waitForImageReady(l).then((()=>{l.style.transition=`opacity 220ms ${h}`,l.style.opacity="1",e.classList.add("img-preloader-fade-out"),setTimeout((()=>e.remove()),220)})).catch((()=>{e.classList.add("img-preloader-error")}))}}else if(n instanceof HTMLElement&&n.classList.contains("img-preloader")){const i=n.getBoundingClientRect(),l=n.cloneNode(!0);l instanceof HTMLElement&&(l.classList.add("image-viewer-article-fade-out"),l.style.cssText=`\n            position:fixed;\n            left:${i.left}px;\n            top:${i.top}px;\n            width:${i.width}px;\n            height:${i.height}px;\n            margin:0;\n            z-index:1003;\n            pointer-events:none;\n          `,document.body.appendChild(l),setTimeout((()=>l.remove()),260));const d=n.getBoundingClientRect();u.articleOriginalNode=n,u.saved={rect:{left:d.left,top:d.top,width:d.width,height:d.height}},u.placeholder=createPlaceholderForNode(n,o),n.replaceWith(u.placeholder);const c=createStagePreloader(s,o);setGenericFlightStyles(c,s,s,w),c.style.transform=r<0?`translate(${f-s.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(s.left+s.width+40)}px, 0px) scale(0.6, 0.6)`,c.style.opacity="0",await nextFrame(),c.style.transition=`transform 420ms ${h}, opacity 420ms ${h}`,c.style.opacity="1",c.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFixedStyles(c),mountPreloaderToStage(c),e(a.src,a.alt).then((e=>{u.isOpen&&u.currentIndex===t&&(e.classList.add("img-preloader-loaded"),mountLoadedImgToStage(e))})).catch((()=>{c.classList.add("img-preloader-error")}))}const d=u.placeholder;if(d){const e=d.getBoundingClientRect().top+window.scrollY,t=Math.max(0,e-.2*window.innerHeight);try{window.scrollTo({top:t,behavior:"smooth"})}catch{window.scrollTo(0,t)}}}),s),setTimeout((()=>{c instanceof HTMLImageElement?(clearFlightStyles(l,!1),restoreOriginal(c,g),d?.replaceWith(c),c.classList.add("image-viewer-article-fade-in"),setTimeout((()=>c.classList.remove("image-viewer-article-fade-in")),260)):c instanceof HTMLElement?(l.remove(),d?.replaceWith(c),c.classList.add("image-viewer-article-fade-in"),setTimeout((()=>c.classList.remove("image-viewer-article-fade-in")),260)):l.remove()}),o),await new Promise((e=>setTimeout(e,o+s+120))),n.classList.remove("switching"),u.isAnimating=!1,scheduleShowSwitcher()}if(t.api={open:async function open(e){if(u.isOpen||u.isAnimating)return;u.isOpen=u.isAnimating=!0;const t=e instanceof HTMLElement?e.closest(".img-preloader")||e:null;u.contextRoot=(e=>{if(!e)return document;const t=e.closest?.(".markdown-body");if(t)return t;const n=e.closest?.("#shuoshuo-content");if(n)return n;const i=e.closest?.(".masonry-item");return i&&i.parentElement||document})(t),u.items=(e=>{const t=Array.from((e||document).querySelectorAll(".markdown-body img, .markdown-body .img-preloader, .masonry-item img, .masonry-item .img-preloader, #shuoshuo-content img, #shuoshuo-content .img-preloader")),n=[];return t.forEach((e=>{if(e instanceof HTMLImageElement){if(!isViewableImg(e))return;const t=e.dataset.originalSrc||e.currentSrc||e.src;n.push({kind:"img",node:e,src:String(t||""),absSrc:toAbsUrl(t),alt:e.alt||"",width:e.naturalWidth||0,height:e.naturalHeight||0})}else if(e instanceof HTMLElement&&isViewablePreloader(e)){const t=e.dataset.src;if(!t)return;const i=Number(e.dataset.width||0),a=Number(e.dataset.height||0);n.push({kind:"preloader",node:e,src:String(t),absSrc:toAbsUrl(t),alt:e.dataset.alt||"",width:Number.isFinite(i)?i:0,height:Number.isFinite(a)?a:0})}})),n})(u.contextRoot),u.currentIndex=((e,t)=>{const n=e.findIndex((e=>e.node===t));if(n>=0)return n;if(t instanceof HTMLImageElement){const n=t.dataset.originalSrc||t.currentSrc||t.src,i=toAbsUrl(n);return e.findIndex((e=>e.absSrc===i))}const i=t?.closest?.(".img-preloader");if(i instanceof HTMLElement){const t=i.dataset.src,n=toAbsUrl(t);return e.findIndex((e=>e.absSrc===n))}return-1})(u.items,t),u.currentIndex<0?u.isOpen=u.isAnimating=!1:(document.documentElement.style.overflow="hidden",u.fixedHidden=window.matchMedia&&window.matchMedia("(max-width: 768px), (pointer: coarse)").matches,u.fixedHidden&&(p&&(clearTimeout(p),p=null),document.querySelectorAll(g).forEach((e=>{e.classList.add("hide")}))),i.innerHTML="",n.style.zIndex="",n.classList.remove("switching"),n.classList.add("active"),hideSwitcher(),r.innerHTML="",u.items.forEach(((e,t)=>{const n=document.createElement("button");n.type="button",n.className="image-viewer-switcher-page",n.dataset.index=String(t),n.textContent=String(t+1),r.appendChild(n)})),updateSwitcherActive(),await openItemAtIndex(u.currentIndex),u.isAnimating=!1,document.addEventListener("keydown",onKeydown),scheduleShowSwitcher())},close:close,isOpen:()=>u.isOpen},o.onclick=()=>navigate(-1),s.onclick=()=>navigate(1),l.onclick=()=>navigate(-1),d.onclick=()=>navigate(1),r.onclick=e=>{if(!u.isOpen||u.isAnimating)return;const t=e.target?.closest?.(".image-viewer-switcher-page");if(!(t instanceof HTMLElement))return;const n=Number(t.dataset.index||"-1");!Number.isFinite(n)||n<0||n>=u.items.length||switchToIndex(n)},t.docBound||(t.handlers.onDocClick=e=>{const n=t.api;if(!n||n.isOpen())return;const i=e.target;if(i instanceof HTMLImageElement){if(!i.matches(".markdown-body img, .masonry-item img, #shuoshuo-content img")||!isViewableImg(i))return;return void n.open(i)}const a=i?.closest?.(".img-preloader");a instanceof HTMLElement&&isViewablePreloader(a)&&a.closest(".markdown-body, .masonry-item, #shuoshuo-content")&&n.open(a)},document.addEventListener("click",t.handlers.onDocClick,!0),t.docBound=!0),t.maskEl!==n&&(t.maskEl&&t.handlers.onMaskClick&&t.maskEl.removeEventListener("click",t.handlers.onMaskClick,!1),t.handlers.onMaskClick=e=>{u.isOpen&&!u.isDragging&&(e.target!==n&&e.target!==i||close())},n.addEventListener("click",t.handlers.onMaskClick,!1),t.maskEl=n),t.stageEl!==i){const e=t.stageEl;e&&["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((n=>{const i=t.handlers[`on${n}`];i&&e.removeEventListener(n,i,!1)})),t.handlers.onwheel=e=>{if(!u.isOpen||!u.activeImg||e.target!==u.activeImg)return;e.preventDefault();const t=u.activeImg.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2,a=u.scale;u.scale=Math.max(.5,Math.min(6,a*(e.deltaY>0?.9:1.1)));const r=u.scale/a-1;u.translateX-=n*r,u.translateY-=i*r,u.activeImg.style.transition="none",applyTransform(),constrainVisible()},t.handlers.onpointerdown=e=>{u.isOpen&&u.activeImg&&e.target===u.activeImg&&(e.preventDefault(),u.activeImg.setPointerCapture(e.pointerId),u.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===u.pointers.size&&(u.dragStartX=e.clientX-u.translateX,u.dragStartY=e.clientY-u.translateY,u.activeImg.style.cursor="grabbing",u.activeImg.style.transition="none"))},t.handlers.onpointermove=e=>{if(u.isOpen&&u.activeImg&&u.pointers.has(e.pointerId)){if(u.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===u.pointers.size)return u.translateX=e.clientX-u.dragStartX,u.translateY=e.clientY-u.dragStartY,u.isDragging=!0,applyTransform(),void constrainVisible();if(2===u.pointers.size){const e=Array.from(u.pointers.values()),t=Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y),n=(e[0].x+e[1].x)/2,i=(e[0].y+e[1].y)/2;u.pinchStart||(u.pinchStart={dist:t,midX:n,midY:i,scale:u.scale,tx:u.translateX,ty:u.translateY});const a=Math.max(.5,Math.min(6,u.pinchStart.scale*(t/u.pinchStart.dist))),r=a/u.scale,o=u.activeImg.getBoundingClientRect(),s=n-(o.left+o.width/2),l=i-(o.top+o.height/2);u.translateX-=s*(r-1),u.translateY-=l*(r-1),u.scale=a,u.isDragging=!0,applyTransform(),constrainVisible()}}},t.handlers.onpointerup=t.handlers.onpointercancel=e=>{if(u.isOpen&&u.activeImg)if(u.pointers.delete(e.pointerId),0===u.pointers.size)u.activeImg.style.cursor="grab",u.pinchStart=null,constrainVisible(),setTimeout((()=>u.isDragging=!1),50);else if(1===u.pointers.size){u.pinchStart=null;const e=Array.from(u.pointers.values())[0];u.dragStartX=e.x-u.translateX,u.dragStartY=e.y-u.translateY}},["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((e=>{i.addEventListener(e,t.handlers[`on${e}`],{passive:!1})})),t.stageEl=i}}
//# sourceMappingURL=imageViewer.js.map