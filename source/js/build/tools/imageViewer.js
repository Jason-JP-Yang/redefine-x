import{requestImageBySrc as e,transformPreloaderToImage as t,loadedPreloaders as n}from"../layouts/lazyload.js";export default function imageViewer(){const i=window.__REDEFINE_X_IMAGE_VIEWER__||(window.__REDEFINE_X_IMAGE_VIEWER__={docBound:!1,maskEl:null,stageEl:null,handlers:{},api:null}),a=document.querySelector(".image-viewer-container"),r=a?.querySelector(".image-viewer-stage"),o=a?.querySelector(".image-viewer-switcher"),s=o?.querySelector(".image-viewer-switcher-pages"),l=o?.querySelector(".image-viewer-switcher-btn.prev"),d=o?.querySelector(".image-viewer-switcher-btn.next"),c=a?.querySelector(".image-viewer-switcher-side.prev"),h=a?.querySelector(".image-viewer-switcher-side.next");if(!(a&&r&&o&&s&&l&&d&&c&&h))return;const m=360,g="cubic-bezier(0.22, 1, 0.36, 1)",p={padding:"2px",backgroundColor:"var(--background-color)",boxShadow:"0 18px 60px rgba(0, 0, 0, 0.35)"},nextFrame=()=>new Promise((e=>requestAnimationFrame((()=>e())))),u=".right-side-tools-container, .aplayer.aplayer-fixed";let w=null;const isViewableImg=e=>e&&!e.closest(".image-viewer-container")&&!e.hasAttribute("data-no-viewer"),isViewablePreloader=e=>e&&!e.closest(".image-viewer-container")&&e.classList.contains("img-preloader"),toAbsUrl=e=>{try{return new URL(e,window.location.href).href}catch{return String(e||"")}},f={isOpen:!1,isAnimating:!1,currentIndex:-1,items:[],contextRoot:null,activeImg:null,activeEl:null,articleOriginalNode:null,placeholder:null,saved:null,switcherShowTimer:null,scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,pointers:new Map,pinchStart:null,fixedHidden:!1},applyTransform=()=>f.activeImg&&(f.activeImg.style.transform=`translate(${f.translateX}px, ${f.translateY}px) scale(${f.scale})`),constrainVisible=()=>{if(!f.activeImg)return;const e=r.getBoundingClientRect(),t=f.activeImg.getBoundingClientRect(),n=.1*t.width,i=.1*t.height;t.right<e.left+n?f.translateX+=e.left+n-t.right:t.left>e.right-n&&(f.translateX+=e.right-n-t.left),t.bottom<e.top+i?f.translateY+=e.top+i-t.bottom:t.top>e.bottom-i&&(f.translateY+=e.bottom-i-t.top),applyTransform()},computeViewerRect=e=>{const t=window.innerWidth,n=window.innerHeight,i=.92*t-4,a=.92*n-4,r=(e.naturalWidth||1)/(e.naturalHeight||1);let o=i,s=o/r;s>a&&(s=a,o=s*r);const l=o+4,d=s+4;return{left:(t-l)/2,top:(n-d)/2,width:l,height:d}},saveOriginal=e=>{const t=getComputedStyle(e),n=(e=>{const t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}})(e);return{parent:e.parentNode,nextSibling:e.nextSibling,styleAttr:e.getAttribute("style"),borderRadius:t.borderRadius,padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,rect:n}},restoreOriginal=(e,t)=>{const n=t||f.saved;n&&(null==n.styleAttr?e.removeAttribute("style"):e.setAttribute("style",n.styleAttr),e.classList.remove("img-preloader-loaded"),e.style.animation="")},y=1009,setFlightStyles=(e,t,n,i,a,r,o)=>{const s=n.left-t.left,l=n.top-t.top,d=n.width/t.width,c=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${a||"0"};\n      box-sizing:border-box;\n      padding:${i?.padding??"0"};\n      background-color:${i?.backgroundColor??"transparent"};\n      box-shadow:${i?.boxShadow??"none"};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${o};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),r.appendChild(e)},animateFlight=async(e,t,n,i)=>(await nextFrame(),await nextFrame(),e.style.transition=[`transform ${t}ms ${g}`,`box-shadow ${t}ms ${g}`,`background-color ${t}ms ${g}`,`padding ${t}ms ${g}`,`border-radius ${t}ms ${g}`].join(", "),e.style.transform="translate(0, 0) scale(1, 1)",n&&(null!=n.padding&&(e.style.padding=n.padding),null!=n.backgroundColor&&(e.style.backgroundColor=n.backgroundColor),null!=n.boxShadow&&(e.style.boxShadow=n.boxShadow)),null!=i&&(e.style.borderRadius=i),new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))),clearFlightStyles=(e,t)=>{const n=["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","animation"];t||n.push("borderRadius","boxSizing","padding","backgroundColor","boxShadow"),n.forEach((t=>e.style[t]=""))},computeViewerRectFromAspect=e=>{const t=window.innerWidth,n=window.innerHeight,i=.92*t-4,a=.92*n-4,r=Number.isFinite(e)&&e>0?e:1;let o=i,s=o/r;s>a&&(s=a,o=s*r);const l=o+4,d=s+4;return{left:(t-l)/2,top:(n-d)/2,width:l,height:d}},getNodeAspectRatio=(e,t)=>{if(t&&t.width>0&&t.height>0)return t.width/t.height;if(e instanceof HTMLImageElement&&e.naturalWidth&&e.naturalHeight)return e.naturalWidth/e.naturalHeight;const n=e?.getBoundingClientRect?.();return n&&n.width>0&&n.height>0?n.width/n.height:1},createPlaceholderForNode=(e,t)=>{const n=document.createElement("span");n.className="image-viewer-placeholder";const i=getComputedStyle(e);return n.style.cssText=`\n      display:${i.display};\n      width:${i.width};\n      max-width:${i.maxWidth};\n      max-height:${i.maxHeight};\n      height:auto;\n      aspect-ratio:${t};\n      margin:${i.margin};\n      padding:0;\n      border:none;\n      visibility:hidden;\n      box-sizing:border-box;\n    `,n},createStagePreloader=(e,t)=>{const n=document.createElement("div");return n.className="img-preloader image-viewer-img-preloader",n.dataset.src="",n.dataset.width="0",n.dataset.height="0",n.style.width=`${e.width}px`,n.style.height=`${e.height}px`,n.style.aspectRatio=`${t}`,n.innerHTML='<div class="img-preloader-skeleton"></div>',n},waitForImageReady=e=>new Promise(((t,n)=>{if(e.complete&&e.naturalWidth)return t(e);const onLoad=()=>cleanup(t,e),onErr=()=>cleanup(n,new Error("Image failed to load")),cleanup=(t,n)=>{e.removeEventListener("load",onLoad),e.removeEventListener("error",onErr),t(n)};e.addEventListener("load",onLoad),e.addEventListener("error",onErr)})),setGenericFlightStyles=(e,t,n,i)=>{const a=n.left-t.left,r=n.top-t.top,o=n.width/t.width,s=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${i};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${a}px, ${r}px) scale(${o}, ${s});\n      opacity:1;\n      animation:none;\n    `,document.body.appendChild(e)},clearFixedStyles=e=>{["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","opacity","animation","boxSizing","padding","backgroundColor","boxShadow","borderRadius"].forEach((t=>{e.style[t]=""}))},onKeydown=e=>{f.isOpen&&("Escape"===e.key?close():"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key&&navigate(1))},getLiveNodeForItem=e=>{if(!f.contextRoot)return e.node;if("preloader"===e.kind){const t=Array.from(f.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc));if(t)return t;return Array.from(f.contextRoot.querySelectorAll(".img-preloader")).find((t=>toAbsUrl(t.dataset.src)===e.absSrc))||e.node}return Array.from(f.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc))||e.node},updateSwitcherActive=()=>{Array.from(s.children).forEach((e=>{if(!(e instanceof HTMLElement))return;const t=Number(e.dataset.index||"-1");e.classList.toggle("active",t===f.currentIndex)}));const e=s.querySelector(`.image-viewer-switcher-page[data-index="${f.currentIndex}"]`);e?.scrollIntoView?.({block:"nearest",inline:"center"})},hideSwitcher=()=>{f.switcherShowTimer&&(clearTimeout(f.switcherShowTimer),f.switcherShowTimer=null),o.classList.remove("shown"),c.classList.remove("shown"),h.classList.remove("shown")},scheduleShowSwitcher=()=>{f.switcherShowTimer&&clearTimeout(f.switcherShowTimer),f.switcherShowTimer=setTimeout((()=>{f.switcherShowTimer=null,f.isOpen&&!f.isAnimating&&(o.classList.add("shown"),c.classList.add("shown"),h.classList.add("shown"))}),300)},mountLoadedImgToStage=e=>{r.innerHTML="",r.appendChild(e),f.activeImg=e,f.activeEl=e,e.style.cursor="grab",e.style.touchAction="none",e.style.width="",e.style.height="",applyTransform(),constrainVisible()},mountPreloaderToStage=e=>{r.innerHTML="",r.appendChild(e),f.activeImg=null,f.activeEl=e},openItemAtIndex=async(i,a)=>{const o=f.items[i];if(!o)return;const s=getLiveNodeForItem(o),l=getNodeAspectRatio(s,o),d=s instanceof HTMLImageElement&&s.naturalWidth&&s.naturalHeight?computeViewerRect(s):computeViewerRectFromAspect(l);if(f.scale=1,f.translateX=f.translateY=0,f.pointers.clear(),f.pinchStart=null,f.isDragging=!1,s instanceof HTMLImageElement){if(f.saved=saveOriginal(s),f.articleOriginalNode=s,f.placeholder=createPlaceholderForNode(s,l),s.before(f.placeholder),setFlightStyles(s,d,f.saved.rect,{padding:f.saved.padding,backgroundColor:f.saved.backgroundColor,boxShadow:f.saved.boxShadow},f.saved.borderRadius,document.body,y),await animateFlight(s,420,p,f.saved.borderRadius),clearFlightStyles(s,!0),mountLoadedImgToStage(s),!s.complete||!s.naturalWidth){const e=createStagePreloader(d,l);r.insertBefore(e,s),s.style.opacity="0",waitForImageReady(s).then((()=>{s.style.transition=`opacity 220ms ${g}`,s.style.opacity="1",e.classList.add("img-preloader-fade-out"),setTimeout((()=>e.remove()),220)})).catch((()=>{e.classList.add("img-preloader-error")}))}}else if(s instanceof HTMLElement&&s.classList.contains("img-preloader")){const i=s.getBoundingClientRect();f.articleOriginalNode=s,f.saved={rect:{left:i.left,top:i.top,width:i.width,height:i.height}},f.placeholder=createPlaceholderForNode(s,l),s.replaceWith(f.placeholder);const a=s.cloneNode(!0);a.classList.add("image-viewer-img-preloader"),a.style.width=`${d.width}px`,a.style.height=`${d.height}px`,a.style.aspectRatio=`${l}`,setGenericFlightStyles(a,d,f.saved.rect,y),await(async(e,t)=>(await nextFrame(),await nextFrame(),e.style.transition=`transform ${t}ms ${g}, opacity ${t}ms ${g}`,e.style.transform="translate(0, 0) scale(1, 1)",new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))))(a,420),clearFixedStyles(a),mountPreloaderToStage(a),e(o.src,o.alt).then((e=>{if(!f.isOpen)return;const i=e;t(s,i),i.classList.remove("img-preloader-fade-out"),f.articleOriginalNode=i,n.add(s),i.style.opacity="0",i.style.transition=`opacity 220ms ${g}`,r.appendChild(i),f.activeImg=i,f.activeEl=i,i.style.cursor="grab",i.style.touchAction="none",i.style.width="",i.style.height="",applyTransform(),constrainVisible(),i.style.opacity="0",a.classList.add("img-preloader-fade-out"),i.offsetWidth,i.style.opacity="1",setTimeout((()=>{a.remove()}),220)})).catch((()=>{a.classList.add("img-preloader-error")}))}};async function close(){if(!f.isOpen||f.isAnimating)return;if(!f.activeEl||!f.placeholder)return;f.isAnimating=!0,document.removeEventListener("keydown",onKeydown),hideSwitcher(),a.classList.remove("switching");const e=f.activeEl,t=f.placeholder;if(f.articleOriginalNode instanceof HTMLImageElement&&e===f.articleOriginalNode){const n=e,i=getComputedStyle(n),o=n.getBoundingClientRect(),s=t.getBoundingClientRect(),l={left:s.left,top:s.top,width:s.width,height:s.height},d=o.left-l.left,c=o.top-l.top,h=o.width/l.width,g=o.height/l.height,p={padding:f.saved?.padding??"0",backgroundColor:f.saved?.backgroundColor??"transparent",boxShadow:f.saved?.boxShadow??"none"};a.style.zIndex=String(1003),n.style.cssText=`\n        position:fixed;\n        left:${l.left}px;\n        top:${l.top}px;\n        width:${l.width}px;\n        height:${l.height}px;\n        border-radius:${i.borderRadius};\n        box-sizing:border-box;\n        padding:${i.padding};\n        background-color:${i.backgroundColor};\n        box-shadow:${i.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${d}px, ${c}px) scale(${h}, ${g});\n        animation:none;\n      `,n.classList.remove("img-preloader-loaded"),document.body.appendChild(n),r.innerHTML="",a.classList.remove("active"),await animateFlight(n,m,p,f.saved?.borderRadius),clearFlightStyles(n,!1),restoreOriginal(n,f.saved),t.replaceWith(n)}else{const n=e.getBoundingClientRect(),i=t.getBoundingClientRect(),o={left:i.left,top:i.top,width:i.width,height:i.height},s=n.left-o.left,l=n.top-o.top,d=n.width/o.width,c=n.height/o.height;a.style.zIndex=String(1003);const h=getComputedStyle(e);e.style.cssText=`\n        position:fixed;\n        left:${o.left}px;\n        top:${o.top}px;\n        width:${o.width}px;\n        height:${o.height}px;\n        border-radius:${h.borderRadius};\n        box-sizing:border-box;\n        padding:${h.padding};\n        background-color:${h.backgroundColor};\n        box-shadow:${h.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n        opacity:1;\n        animation:none;\n      `,document.body.appendChild(e),r.innerHTML="",a.classList.remove("active"),await nextFrame(),await nextFrame(),e.style.transition=`transform 360ms ${g}, opacity 360ms ${g}`,e.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,440))),e.remove(),f.articleOriginalNode instanceof HTMLElement&&t.replaceWith(f.articleOriginalNode)}document.documentElement.style.overflow="",f.fixedHidden&&(((e=300)=>{w=setTimeout((()=>{document.querySelectorAll(u).forEach((e=>{e.classList.remove("hide")})),w=null}),e)})(300),f.fixedHidden=!1),f.activeImg=f.activeEl=null,f.articleOriginalNode=null,f.placeholder=null,f.saved=null,f.pointers.clear(),f.pinchStart=null,f.isOpen=f.isAnimating=!1,a.style.zIndex=""}async function navigate(e){if(!f.isOpen||f.items.length<=1||f.isAnimating)return;const t=(f.currentIndex+e+f.items.length)%f.items.length;await switchToIndex(t)}async function switchToIndex(i){if(!f.isOpen||f.isAnimating)return;if(i===f.currentIndex)return;const o=f.items[i];if(!o)return;const s=i>f.currentIndex?-1:1,l=420,d=Math.round(210);f.isAnimating=!0,hideSwitcher(),a.classList.add("switching");const c=f.activeEl,h=f.placeholder,m=f.articleOriginalNode,u=f.saved,w=c.getBoundingClientRect();r.innerHTML="",((e,t,n)=>{const i=getComputedStyle(e);e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${i.borderRadius};\n      box-sizing:border-box;\n      padding:${i.padding};\n      background-color:${i.backgroundColor};\n      box-shadow:${i.boxShadow};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${n};\n      pointer-events:none;\n      transform-origin:center;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(0, 0) scale(1, 1);\n      opacity:1;\n      animation:none;\n    `})(c,w,y),document.body.appendChild(c);const x=window.innerWidth,v=window.innerHeight/2-(w.top+w.height/2),b=s<0?-(w.left+w.width+40):x-w.left+40;await nextFrame(),await nextFrame(),c.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,c.style.transform=`translate(${b}px, ${v}px) scale(0.6, 0.6)`,c.style.opacity="0",setTimeout((async()=>{if(!f.isOpen)return;f.currentIndex=i,updateSwitcherActive();const a=getLiveNodeForItem(o),l=getNodeAspectRatio(a,o),d=a instanceof HTMLImageElement&&a.naturalWidth&&a.naturalHeight?computeViewerRect(a):computeViewerRectFromAspect(l);let c;if(f.scale=1,f.translateX=f.translateY=0,f.pointers.clear(),f.pinchStart=null,f.isDragging=!1,a instanceof HTMLImageElement){if(f.saved=saveOriginal(a),f.articleOriginalNode=a,f.placeholder=createPlaceholderForNode(a,l),a.before(f.placeholder),c=a,setFlightStyles(c,d,d,p,f.saved.borderRadius,document.body,y),c.style.transform=s<0?`translate(${x-d.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(d.left+d.width+40)}px, 0px) scale(0.6, 0.6)`,c.style.opacity="0",await nextFrame(),c.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,c.style.opacity="1",c.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFlightStyles(c,!0),mountLoadedImgToStage(c),!c.complete||!c.naturalWidth){const e=createStagePreloader(d,l);r.insertBefore(e,c),c.style.opacity="0",waitForImageReady(c).then((()=>{c.style.transition=`opacity 220ms ${g}`,c.style.opacity="1",e.classList.add("img-preloader-fade-out"),setTimeout((()=>e.remove()),220)})).catch((()=>{e.classList.add("img-preloader-error")}))}}else if(a instanceof HTMLElement&&a.classList.contains("img-preloader")){const r=a.getBoundingClientRect();f.articleOriginalNode=a,f.saved={rect:{left:r.left,top:r.top,width:r.width,height:r.height}},f.placeholder=createPlaceholderForNode(a,l),a.replaceWith(f.placeholder);const c=createStagePreloader(d,l);setGenericFlightStyles(c,d,d,y),c.style.transform=s<0?`translate(${x-d.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(d.left+d.width+40)}px, 0px) scale(0.6, 0.6)`,c.style.opacity="0",await nextFrame(),c.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,c.style.opacity="1",c.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFixedStyles(c),mountPreloaderToStage(c),e(o.src,o.alt).then((e=>{if(!f.isOpen||f.currentIndex!==i)return;const r=e;t(a,r),r.classList.remove("img-preloader-fade-out"),f.articleOriginalNode=r,n.add(a),mountLoadedImgToStage(r)})).catch((()=>{c.classList.add("img-preloader-error")}))}const h=f.placeholder;if(h){const e=h.getBoundingClientRect().top+window.scrollY,t=Math.max(0,e-.2*window.innerHeight);try{window.scrollTo({top:t,behavior:"smooth"})}catch{window.scrollTo(0,t)}}}),d),setTimeout((()=>{m instanceof HTMLImageElement?(clearFlightStyles(c,!1),restoreOriginal(m,u),h?.replaceWith(m),m.classList.add("image-viewer-article-fade-in"),setTimeout((()=>m.classList.remove("image-viewer-article-fade-in")),260)):m instanceof HTMLElement?(c.remove(),h?.replaceWith(m),m.classList.add("image-viewer-article-fade-in"),setTimeout((()=>m.classList.remove("image-viewer-article-fade-in")),260)):c.remove()}),l),await new Promise((e=>setTimeout(e,l+d+120))),a.classList.remove("switching"),f.isAnimating=!1,scheduleShowSwitcher()}if(i.api={open:async function open(e){if(f.isOpen||f.isAnimating)return;f.isOpen=f.isAnimating=!0;const t=e instanceof HTMLElement?e.closest(".img-preloader")||e:null;f.contextRoot=(e=>{if(!e)return document;const t=e.closest?.(".markdown-body");if(t)return t;const n=e.closest?.("#shuoshuo-content");if(n)return n;const i=e.closest?.(".masonry-item");return i&&i.parentElement||document})(t),f.items=(e=>{const t=Array.from((e||document).querySelectorAll(".markdown-body img, .markdown-body .img-preloader, .masonry-item img, .masonry-item .img-preloader, #shuoshuo-content img, #shuoshuo-content .img-preloader")),n=[];return t.forEach((e=>{if(e instanceof HTMLImageElement){if(!isViewableImg(e))return;const t=e.dataset.originalSrc||e.currentSrc||e.src;n.push({kind:"img",node:e,src:String(t||""),absSrc:toAbsUrl(t),alt:e.alt||"",width:e.naturalWidth||0,height:e.naturalHeight||0})}else if(e instanceof HTMLElement&&isViewablePreloader(e)){const t=e.dataset.src;if(!t)return;const i=Number(e.dataset.width||0),a=Number(e.dataset.height||0);n.push({kind:"preloader",node:e,src:String(t),absSrc:toAbsUrl(t),alt:e.dataset.alt||"",width:Number.isFinite(i)?i:0,height:Number.isFinite(a)?a:0})}})),n})(f.contextRoot),f.currentIndex=((e,t)=>{const n=e.findIndex((e=>e.node===t));if(n>=0)return n;if(t instanceof HTMLImageElement){const n=t.dataset.originalSrc||t.currentSrc||t.src,i=toAbsUrl(n);return e.findIndex((e=>e.absSrc===i))}const i=t?.closest?.(".img-preloader");if(i instanceof HTMLElement){const t=i.dataset.src,n=toAbsUrl(t);return e.findIndex((e=>e.absSrc===n))}return-1})(f.items,t),f.currentIndex<0?f.isOpen=f.isAnimating=!1:(document.documentElement.style.overflow="hidden",f.fixedHidden=window.matchMedia&&window.matchMedia("(max-width: 768px), (pointer: coarse)").matches,f.fixedHidden&&(w&&(clearTimeout(w),w=null),document.querySelectorAll(u).forEach((e=>{e.classList.add("hide")}))),r.innerHTML="",a.style.zIndex="",a.classList.remove("switching"),a.classList.add("active"),hideSwitcher(),s.innerHTML="",f.items.forEach(((e,t)=>{const n=document.createElement("button");n.type="button",n.className="image-viewer-switcher-page",n.dataset.index=String(t),n.textContent=String(t+1),s.appendChild(n)})),updateSwitcherActive(),await openItemAtIndex(f.currentIndex),f.isAnimating=!1,document.addEventListener("keydown",onKeydown),scheduleShowSwitcher())},close:close,isOpen:()=>f.isOpen},l.onclick=()=>navigate(-1),d.onclick=()=>navigate(1),c.onclick=()=>navigate(-1),h.onclick=()=>navigate(1),s.onclick=e=>{if(!f.isOpen||f.isAnimating)return;const t=e.target?.closest?.(".image-viewer-switcher-page");if(!(t instanceof HTMLElement))return;const n=Number(t.dataset.index||"-1");!Number.isFinite(n)||n<0||n>=f.items.length||switchToIndex(n)},i.docBound||(i.handlers.onDocClick=e=>{const t=i.api;if(!t||t.isOpen())return;const n=e.target;if(n instanceof HTMLImageElement){if(!n.matches(".markdown-body img, .masonry-item img, #shuoshuo-content img")||!isViewableImg(n))return;return void t.open(n)}const a=n?.closest?.(".img-preloader");a instanceof HTMLElement&&isViewablePreloader(a)&&a.closest(".markdown-body, .masonry-item, #shuoshuo-content")&&t.open(a)},document.addEventListener("click",i.handlers.onDocClick,!0),i.docBound=!0),i.maskEl!==a&&(i.maskEl&&i.handlers.onMaskClick&&i.maskEl.removeEventListener("click",i.handlers.onMaskClick,!1),i.handlers.onMaskClick=e=>{f.isOpen&&!f.isDragging&&(e.target!==a&&e.target!==r||close())},a.addEventListener("click",i.handlers.onMaskClick,!1),i.maskEl=a),i.stageEl!==r){const e=i.stageEl;e&&["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((t=>{const n=i.handlers[`on${t}`];n&&e.removeEventListener(t,n,!1)})),i.handlers.onwheel=e=>{if(!f.isOpen||!f.activeImg||e.target!==f.activeImg)return;e.preventDefault();const t=f.activeImg.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2,a=f.scale;f.scale=Math.max(.5,Math.min(6,a*(e.deltaY>0?.9:1.1)));const r=f.scale/a-1;f.translateX-=n*r,f.translateY-=i*r,f.activeImg.style.transition="none",applyTransform(),constrainVisible()},i.handlers.onpointerdown=e=>{f.isOpen&&f.activeImg&&e.target===f.activeImg&&(e.preventDefault(),f.activeImg.setPointerCapture(e.pointerId),f.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===f.pointers.size&&(f.dragStartX=e.clientX-f.translateX,f.dragStartY=e.clientY-f.translateY,f.activeImg.style.cursor="grabbing",f.activeImg.style.transition="none"))},i.handlers.onpointermove=e=>{if(f.isOpen&&f.activeImg&&f.pointers.has(e.pointerId)){if(f.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===f.pointers.size)return f.translateX=e.clientX-f.dragStartX,f.translateY=e.clientY-f.dragStartY,f.isDragging=!0,applyTransform(),void constrainVisible();if(2===f.pointers.size){const e=Array.from(f.pointers.values()),t=Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y),n=(e[0].x+e[1].x)/2,i=(e[0].y+e[1].y)/2;f.pinchStart||(f.pinchStart={dist:t,midX:n,midY:i,scale:f.scale,tx:f.translateX,ty:f.translateY});const a=Math.max(.5,Math.min(6,f.pinchStart.scale*(t/f.pinchStart.dist))),r=a/f.scale,o=f.activeImg.getBoundingClientRect(),s=n-(o.left+o.width/2),l=i-(o.top+o.height/2);f.translateX-=s*(r-1),f.translateY-=l*(r-1),f.scale=a,f.isDragging=!0,applyTransform(),constrainVisible()}}},i.handlers.onpointerup=i.handlers.onpointercancel=e=>{if(f.isOpen&&f.activeImg)if(f.pointers.delete(e.pointerId),0===f.pointers.size)f.activeImg.style.cursor="grab",f.pinchStart=null,constrainVisible(),setTimeout((()=>f.isDragging=!1),50);else if(1===f.pointers.size){f.pinchStart=null;const e=Array.from(f.pointers.values())[0];f.dragStartX=e.x-f.translateX,f.dragStartY=e.y-f.translateY}},["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((e=>{r.addEventListener(e,i.handlers[`on${e}`],{passive:!1})})),i.stageEl=r}}
//# sourceMappingURL=imageViewer.js.map