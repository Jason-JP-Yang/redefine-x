import{requestImageBySrc as e,transformPreloaderToImage as t,loadedPreloaders as i}from"../layouts/lazyload.js";export default function imageViewer(){const n=window.__REDEFINE_X_IMAGE_VIEWER__||(window.__REDEFINE_X_IMAGE_VIEWER__={docBound:!1,maskEl:null,stageEl:null,handlers:{},api:null}),a=document.querySelector(".image-viewer-container"),o=a?.querySelector(".image-viewer-stage"),r=a?.querySelector(".image-viewer-switcher"),s=r?.querySelector(".image-viewer-switcher-pages"),l=r?.querySelector(".image-viewer-switcher-btn.prev"),d=r?.querySelector(".image-viewer-switcher-btn.next"),c=a?.querySelector(".image-viewer-switcher-side.prev"),m=a?.querySelector(".image-viewer-switcher-side.next"),h=a?.querySelector(".image-viewer-info-trigger"),g=h?.querySelector(".image-viewer-info-content");if(!(a&&o&&r&&s&&l&&d&&c&&m&&h&&g))return;const p=360,u="cubic-bezier(0.22, 1, 0.36, 1)",f=300,y=(()=>{const e=document.createElement("img");e.alt="",e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",o.appendChild(e);const t=getComputedStyle(e),i={padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,borderRadius:t.borderRadius};return e.remove(),i})(),w=(()=>{const e=document.createElement("div");e.className="img-preloader image-viewer-img-preloader",e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",e.style.width="200px",e.style.height="120px",e.innerHTML='<div class="img-preloader-skeleton"></div>',o.appendChild(e);const t=getComputedStyle(e),i={padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,borderRadius:t.borderRadius};return e.remove(),i})(),v={padding:y.padding,backgroundColor:y.backgroundColor,boxShadow:y.boxShadow},nextFrame=()=>new Promise((e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))})),playPreloaderPop=e=>{e&&(e.classList.add("img-preloader-loaded"),e.style.animation="img-preloader-fade-in 300ms ease forwards",setTimeout((()=>{e.isConnected&&(e.style.animation="",e.classList.remove("img-preloader-loaded"),applyTransform())}),340))},x=".right-side-tools-container, .aplayer.aplayer-fixed";let b=null;const isViewableImg=e=>e&&!e.closest(".image-viewer-container")&&!e.hasAttribute("data-no-viewer"),isViewablePreloader=e=>e&&!e.closest(".image-viewer-container")&&e.classList.contains("img-preloader"),toAbsUrl=e=>{try{return new URL(e,window.location.href).href}catch{return String(e||"")}},L={isOpen:!1,isAnimating:!1,currentIndex:-1,items:[],contextRoot:null,activeImg:null,activeEl:null,articleOriginalNode:null,placeholder:null,saved:null,switcherShowTimer:null,scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,pointers:new Map,pinchStart:null,fixedHidden:!1,infoStatus:"closed",infoTimer:null,infoReadyTimer:null},applyTransform=()=>L.activeImg&&(L.activeImg.style.transform=`translate(${L.translateX}px, ${L.translateY}px) scale(${L.scale})`),constrainVisible=()=>{if(!L.activeImg)return;const e=o.getBoundingClientRect(),t=L.activeImg.getBoundingClientRect(),i=.1*t.width,n=.1*t.height;t.right<e.left+i?L.translateX+=e.left+i-t.right:t.left>e.right-i&&(L.translateX+=e.right-i-t.left),t.bottom<e.top+n?L.translateY+=e.top+n-t.bottom:t.top>e.bottom-n&&(L.translateY+=e.bottom-n-t.top),applyTransform()},getViewerContentRect=()=>{const e=a.getBoundingClientRect(),t=getComputedStyle(a),i=parseFloat(t.paddingLeft||"0")||0,n=parseFloat(t.paddingRight||"0")||0,o=parseFloat(t.paddingTop||"0")||0,r=parseFloat(t.paddingBottom||"0")||0;return{left:e.left+i,top:e.top+o,width:Math.max(0,e.width-i-n),height:Math.max(0,e.height-o-r)}},computeViewerRect=e=>{const t=getViewerContentRect(),i=t.width-4,n=t.height-4,a=(e.naturalWidth||1)/(e.naturalHeight||1);let o=i,r=o/a;r>n&&(r=n,o=r*a);const s=o+4,l=r+4;return{left:t.left+(t.width-s)/2,top:t.top+(t.height-l)/2,width:s,height:l}},saveOriginal=e=>{const t=getComputedStyle(e),i=(e=>{const t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}})(e);return{parent:e.parentNode,nextSibling:e.nextSibling,styleAttr:e.getAttribute("style"),borderRadius:t.borderRadius,padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,rect:i}},restoreOriginal=(e,t)=>{const i=t||L.saved;i&&(null==i.styleAttr?e.removeAttribute("style"):e.setAttribute("style",i.styleAttr),e.classList.remove("img-preloader-loaded"),e.style.animation="")},T=1009,setFlightStyles=(e,t,i,n,a,o,r)=>{const s=i.left-t.left,l=i.top-t.top,d=i.width/t.width,c=i.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${a||"0"};\n      clip-path: inset(0 round ${a||"0"});\n      -webkit-clip-path: inset(0 round ${a||"0"});\n      box-sizing:border-box;\n      overflow:hidden;\n      padding:${n?.padding??"0"};\n      background-color:${n?.backgroundColor??"transparent"};\n      box-shadow:${n?.boxShadow??"none"};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${r};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity,border-radius,box-shadow,padding; \n      transition:none;\n      transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),o.appendChild(e),e.offsetWidth},animateFlight=async(e,t,i,n)=>(await nextFrame(),await nextFrame(),e.style.transition=[`transform ${t}ms ${u}`,`box-shadow ${t}ms ${u}`,`background-color ${t}ms ${u}`,`padding ${t}ms ${u}`,`border-radius ${t}ms ${u}`].join(", "),e.style.transform="translate(0, 0) scale(1, 1)",i&&(null!=i.padding&&(e.style.padding=i.padding),null!=i.backgroundColor&&(e.style.backgroundColor=i.backgroundColor),null!=i.boxShadow&&(e.style.boxShadow=i.boxShadow)),null!=n&&(e.style.borderRadius=n),new Promise((i=>{let n=!1;const finish=()=>{n||(n=!0,e.removeEventListener("transitionend",onEnd),i())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+100)}))),clearFlightStyles=(e,t)=>{const i=["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","animation"];t||i.push("borderRadius","clipPath","webkitClipPath","boxSizing","padding","backgroundColor","boxShadow"),i.forEach((t=>e.style[t]=""))},computeViewerRectFromAspect=e=>{const t=getViewerContentRect(),i=t.width-4,n=t.height-4,a=Number.isFinite(e)&&e>0?e:1;let o=i,r=o/a;r>n&&(r=n,o=r*a);const s=o+4,l=r+4;return{left:t.left+(t.width-s)/2,top:t.top+(t.height-l)/2,width:s,height:l}},getNodeAspectRatio=(e,t)=>{if(t&&t.width>0&&t.height>0)return t.width/t.height;if(e instanceof HTMLImageElement&&e.naturalWidth&&e.naturalHeight)return e.naturalWidth/e.naturalHeight;const i=e?.getBoundingClientRect?.();return i&&i.width>0&&i.height>0?i.width/i.height:1},createPlaceholderForNode=(e,t)=>{const i=document.createElement("span");i.className="image-viewer-placeholder";const n=getComputedStyle(e);return i.style.cssText=`\n      display:${n.display};\n      width:${n.width};\n      max-width:${n.maxWidth};\n      max-height:${n.maxHeight};\n      height:auto;\n      aspect-ratio:${t};\n      margin:${n.margin};\n      padding:0;\n      border:none;\n      visibility:hidden;\n      box-sizing:border-box;\n    `,i},createStagePreloader=(e,t)=>{const i=document.createElement("div");return i.className="img-preloader image-viewer-img-preloader",i.dataset.src="",i.dataset.width="0",i.dataset.height="0",i.style.width=`${e.width}px`,i.style.height=`${e.height}px`,i.style.aspectRatio=`${t}`,i.style.maxWidth="none",i.style.maxHeight="none",i.innerHTML='<div class="img-preloader-skeleton"></div>',i},setViewerPreloaderError=(e,t="")=>{if(!(e instanceof HTMLElement))return;const i=e.getBoundingClientRect();i.width&&i.height&&(e.style.width=`${i.width}px`,e.style.height=`${i.height}px`,e.style.aspectRatio=""+i.width/i.height,e.style.maxWidth="none",e.style.maxHeight="none"),e.classList.add("img-preloader-error");const n=e.querySelector(".img-preloader-skeleton");n&&(n.innerHTML=`\n      <i class="fa-solid fa-circle-xmark img-preloader-error-icon"></i>\n      <div class="img-preloader-error-text">\n        <div class="error-message">Failed to load image</div>\n        <div class="error-url">${t}</div>\n      </div>\n    `)},waitForImageReady=e=>new Promise(((t,i)=>{if(e.complete&&e.naturalWidth)return t(e);const onLoad=()=>cleanup(t,e),onErr=()=>cleanup(i,new Error("Image failed to load")),cleanup=(t,i)=>{e.removeEventListener("load",onLoad),e.removeEventListener("error",onErr),t(i)};e.addEventListener("load",onLoad),e.addEventListener("error",onErr)})),setGenericFlightStyles=(e,t,i,n)=>{const a=i.left-t.left,o=i.top-t.top,r=i.width/t.width,s=i.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${n};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${a}px, ${o}px) scale(${r}, ${s});\n      opacity:1;\n      animation:none;\n      box-sizing:border-box;\n      overflow:hidden;\n      padding:${w.padding};\n      background-color:${w.backgroundColor};\n      border-radius:${w.borderRadius};\n      clip-path: inset(0 round ${w.borderRadius});\n      -webkit-clip-path: inset(0 round ${w.borderRadius});\n      box-shadow:${w.boxShadow};\n    `,document.body.appendChild(e),e.offsetWidth},clearFixedStylesKeepStageSize=e=>{["position","left","top","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","opacity","animation"].forEach((t=>{e.style[t]=""}))},onKeydown=e=>{L.isOpen&&("Escape"===e.key?close():"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key&&navigate(1))},getLiveNodeForItem=e=>{if(!L.contextRoot)return e.node;if("preloader"===e.kind){const t=Array.from(L.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc));if(t)return t;return Array.from(L.contextRoot.querySelectorAll(".img-preloader")).find((t=>toAbsUrl(t.dataset.src)===e.absSrc))||e.node}return Array.from(L.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc))||e.node},updateSwitcher=()=>{s.innerHTML="";const e=L.items.length;if(e<=1)return s.style.display="none",c.style.display="none",void(m.style.display="none");c.style.display="",m.style.display="";const t=parseFloat(getComputedStyle(r).gap||"0")||0,i=parseFloat(getComputedStyle(s).gap||"0")||0,isVisible=e=>{if(!(e instanceof HTMLElement))return!1;const t=getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;const i=e.getBoundingClientRect();return i.width>0&&i.height>0},n=document.documentElement.clientWidth||window.innerWidth,a=Math.floor(.8*n),o=isVisible(l),h=isVisible(d),g=(o?l.getBoundingClientRect().width:0)+(h?d.getBoundingClientRect().width:0)+((o?1:0)+(h?1:0))*t,p=Math.max(0,a-g),u=Math.floor((p+i)/(38+i));if(u<3)return void(s.style.display="none");s.style.display="";const f=L.currentIndex+1;buildPaginationTokens(e,f,u).forEach((e=>{"ellipsis"===e?createEllipsis():createSwitcherBtn(e-1,e)})),updateSwitcherActive()},buildPaginationTokens=(e,t,i)=>{if(e<=i)return Array.from({length:e},((e,t)=>t+1));if(3===i){let i=Math.max(1,Math.min(t-1,e-2));return[i,i+1,i+2]}if(4===i)return t<=2?[1,2,3,"ellipsis"]:t>=e-1?["ellipsis",e-2,e-1,e]:["ellipsis",t-1,t,"ellipsis"];if(5===i)return t<=3?[1,2,3,4,"ellipsis"]:t>=e-2?["ellipsis",e-3,e-2,e-1,e]:["ellipsis",t-1,t,t+1,"ellipsis"];const n=i-2;if(t<=n-1){return[...Array.from({length:n},((e,t)=>t+1)),"ellipsis",e]}if(t>=e-(n-2)){const t=e-n+1;return[1,"ellipsis",...Array.from({length:n},((e,i)=>t+i))]}const a=n-2;let o=t-Math.floor(a/2),r=o+a-1;o<2&&(o=2,r=o+a-1),r>e-1&&(r=e-1,o=r-a+1);return[1,"ellipsis",...Array.from({length:a},((e,t)=>o+t)),"ellipsis",e]},createSwitcherBtn=(e,t)=>{const i=document.createElement("button");i.type="button",i.className="image-viewer-switcher-page",i.dataset.index=String(e),i.textContent=String(t),s.appendChild(i)},createEllipsis=()=>{const e=document.createElement("div");e.className="image-viewer-switcher-ellipsis",e.innerHTML='\n      <span class="dot"></span>\n      <span class="dot"></span>\n      <span class="dot"></span>\n    ',s.appendChild(e)},updateSwitcherActive=()=>{Array.from(s.children).forEach((e=>{if(!(e instanceof HTMLElement))return;const t=Number(e.dataset.index||"-1");e.classList.toggle("active",t===L.currentIndex)}));const e=s.querySelector(`.image-viewer-switcher-page[data-index="${L.currentIndex}"]`);e?.scrollIntoView?.({block:"nearest",inline:"center"})},hideSwitcher=()=>{L.switcherShowTimer&&(clearTimeout(L.switcherShowTimer),L.switcherShowTimer=null),r.classList.remove("shown"),c.classList.remove("shown"),m.classList.remove("shown")},scheduleShowSwitcher=()=>{L.switcherShowTimer&&clearTimeout(L.switcherShowTimer),L.switcherShowTimer=setTimeout((()=>{L.switcherShowTimer=null,L.isOpen&&!L.isAnimating&&(r.classList.add("shown"),c.classList.add("shown"),m.classList.add("shown"))}),300)},mountLoadedImgToStage=(e,t=!0)=>{t&&(o.innerHTML=""),e.classList.remove("img-preloader-loaded"),e.style.animation="",o.appendChild(e),L.activeImg=e,L.activeEl=e,e.style.cursor="grab",e.style.touchAction="none",e.style.width="",e.style.height="",applyTransform(),constrainVisible()},mountPreloaderToStage=e=>{o.innerHTML="",o.appendChild(e),L.activeImg=null,L.activeEl=e},resetInfoInstant=()=>{L.infoTimer&&(clearTimeout(L.infoTimer),L.infoTimer=null),L.infoReadyTimer&&(clearTimeout(L.infoReadyTimer),L.infoReadyTimer=null),h.classList.remove("active","closing","no-hover","info-content-ready"),h.style.height="",L.infoStatus="closed"},measureInfoSize=()=>{h.classList.add("active","measuring"),g.style.display="block";const e=h.offsetWidth,t=h.offsetHeight;return h.classList.remove("active","measuring"),g.style.display="",{w:e,h:t}},closeInfo=()=>{if(!h.classList.contains("active"))return;if(h.classList.contains("closing"))return;L.infoTimer&&(clearTimeout(L.infoTimer),L.infoTimer=null),L.infoReadyTimer&&(clearTimeout(L.infoReadyTimer),L.infoReadyTimer=null);const e=h.offsetWidth,t=h.offsetHeight;h.classList.remove("info-content-ready"),h.style.width=`${e}px`,h.style.height=`${t}px`,h.offsetWidth,h.classList.add("no-hover"),h.classList.add("closing"),h.style.width="38px",h.style.height="38px",L.infoStatus="closing",L.infoTimer=setTimeout((()=>{h.classList.remove("active","closing","no-hover","info-content-ready"),h.style.height="",h.style.width="",L.infoStatus="closed",L.infoTimer=null}),720)},updateInfo=()=>{const e=h.classList.contains("active")&&!h.classList.contains("closing");g.innerHTML="",h.style.display="none",e||resetInfoInstant();const t=L.items[L.currentIndex];if(!t)return;const i=getLiveNodeForItem(t);if(!i)return;let n=!1;const a=i.closest(".image-exif-container");if(a){const e=a.querySelector(".image-exif-info-card");if(e){const t=document.createElement("div");t.className="image-exif-container image-exif-block";const i=e.cloneNode(!0);i.classList.add("expanded"),i.style.removeProperty("max-width"),i.style.removeProperty("width"),i.querySelectorAll(".image-exif-toggle-btn").forEach((e=>e.remove())),i.querySelectorAll(".image-exif-data").forEach((e=>{e.style.removeProperty("height"),e.style.removeProperty("opacity"),e.style.removeProperty("margin-top"),e.style.removeProperty("grid-template-columns")})),t.appendChild(i),g.appendChild(t),n=!0}}if(!n){const e=i.closest("figure.image-caption");if(e){const t=e.querySelector("figcaption");if(t&&t.textContent.trim()){const e=document.createElement("figure");e.className="image-caption",e.appendChild(t.cloneNode(!0)),g.appendChild(e),n=!0}}}if(!n&&t.alt&&t.alt.trim()){const e=document.createElement("figure");e.className="image-caption";const i=document.createElement("figcaption");i.textContent=t.alt,e.appendChild(i),g.appendChild(e),n=!0}if(!n)return resetInfoInstant(),void(h.style.display="none");if(h.style.display="flex",e){const e=measureInfoSize();h.style.width=`${e.w}px`,h.style.height=`${e.h}px`}},openItemAtIndex=async(n,a)=>{const o=L.items[n];if(!o)return;const r=getLiveNodeForItem(o),s=getNodeAspectRatio(r,o),l=r instanceof HTMLImageElement&&r.naturalWidth&&r.naturalHeight?computeViewerRect(r):computeViewerRectFromAspect(s);if(L.scale=1,L.translateX=L.translateY=0,L.pointers.clear(),L.pinchStart=null,L.isDragging=!1,r instanceof HTMLImageElement){if(L.saved=saveOriginal(r),L.articleOriginalNode=r,L.placeholder=createPlaceholderForNode(r,s),r.before(L.placeholder),setFlightStyles(r,l,L.saved.rect,v,y.borderRadius,document.body,T),await animateFlight(r,420,v,y.borderRadius),clearFlightStyles(r,!0),r.complete&&r.naturalWidth)return void mountLoadedImgToStage(r);const e=createStagePreloader(l,s);return mountPreloaderToStage(e),r.remove(),void waitForImageReady(r).then((async()=>{if(L.isOpen){try{await r.decode()}catch{}await nextFrame(),e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",mountLoadedImgToStage(r,!1),playPreloaderPop(r),setTimeout((()=>{e.remove(),r.style.transition=""}),f)}})).catch((()=>{setViewerPreloaderError(e,o.src)}))}if(r instanceof HTMLElement&&r.classList.contains("img-preloader")){const n=r.getBoundingClientRect(),a=r.classList.contains("img-preloader-error")?{left:n.left,top:n.top,width:n.width,height:n.width/s}:n;L.articleOriginalNode=r,L.saved={rect:{left:a.left,top:a.top,width:a.width,height:a.height}},L.placeholder=createPlaceholderForNode(r,s),r.replaceWith(L.placeholder);const d=r.cloneNode(!0);d.classList.add("image-viewer-img-preloader"),d.classList.remove("img-preloader-fade-out","img-preloader-loaded","img-preloader-error"),d.style.opacity="1",d.style.width=`${l.width}px`,d.style.height=`${l.height}px`,d.style.aspectRatio=`${s}`,setGenericFlightStyles(d,l,L.saved.rect,T),await(async(e,t)=>(await nextFrame(),await nextFrame(),e.style.transition=`transform ${t}ms ${u}, opacity ${t}ms ${u}`,e.style.transform="translate(0, 0) scale(1, 1)",new Promise((i=>{let n=!1;const finish=()=>{n||(n=!0,e.removeEventListener("transitionend",onEnd),i())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))))(d,420),clearFixedStylesKeepStageSize(d),mountPreloaderToStage(d),e(o.src,o.alt).then((async e=>{if(!L.isOpen)return;try{await e.decode()}catch{}const n=e;t(r,n),n.classList.remove("img-preloader-fade-out"),L.articleOriginalNode=n,i.add(r),d.remove(),mountLoadedImgToStage(n),playPreloaderPop(n)})).catch((()=>{setViewerPreloaderError(d,o.src)}))}};async function close(){if(!L.isOpen||L.isAnimating)return;if(!L.activeEl||!L.placeholder)return;L.isAnimating=!0,document.removeEventListener("keydown",onKeydown),L.resizeHandler&&(window.removeEventListener("resize",L.resizeHandler),L.resizeHandler=null),L.resizeTimer&&(clearTimeout(L.resizeTimer),L.resizeTimer=null),hideSwitcher(),a.classList.remove("switching"),h.style.display="none",resetInfoInstant();const e=L.activeEl,t=L.placeholder;if(L.articleOriginalNode instanceof HTMLImageElement&&e===L.articleOriginalNode){const i=e,n=getComputedStyle(i),r=i.getBoundingClientRect(),s=t.getBoundingClientRect(),l={left:s.left,top:s.top,width:s.width,height:s.height},d=r.left-l.left,c=r.top-l.top,m=r.width/l.width,h=r.height/l.height,g={padding:L.saved?.padding??"0",backgroundColor:L.saved?.backgroundColor??"transparent",boxShadow:L.saved?.boxShadow??"none"};a.style.zIndex=String(1003),i.style.cssText=`\n        position:fixed;\n        left:${l.left}px;\n        top:${l.top}px;\n        width:${l.width}px;\n        height:${l.height}px;\n        border-radius:${n.borderRadius};\n        box-sizing:border-box;\n        padding:${n.padding};\n        background-color:${n.backgroundColor};\n        box-shadow:${n.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${d}px, ${c}px) scale(${m}, ${h});\n        animation:none;\n      `,i.classList.remove("img-preloader-loaded"),document.body.appendChild(i),o.innerHTML="",a.classList.remove("active"),await animateFlight(i,p,g,L.saved?.borderRadius),clearFlightStyles(i,!1),restoreOriginal(i,L.saved),t.replaceWith(i)}else{const i=e.getBoundingClientRect(),n=t.getBoundingClientRect(),r={left:n.left,top:n.top,width:n.width,height:n.height},s=i.left-r.left,l=i.top-r.top,d=i.width/r.width,c=i.height/r.height;e.classList.contains("image-viewer-img-preloader")||e.classList.contains("img-preloader");if(e.classList.contains("img-preloader-error")){if(a.classList.remove("active"),e.style.transition=`opacity 360ms ${u}`,e.style.opacity="0",await new Promise((e=>setTimeout(e,p))),e.remove(),L.articleOriginalNode instanceof HTMLElement){const e=L.articleOriginalNode;t.replaceWith(e),e.style.opacity="0",e.animate([{opacity:0},{opacity:1}],{duration:220,easing:"ease-out",fill:"forwards"}),setTimeout((()=>{e.isConnected&&(e.style.opacity="")}),220)}}else{a.style.zIndex=String(1003);const i=getComputedStyle(e);e.style.cssText=`\n            position:fixed;\n            left:${r.left}px;\n            top:${r.top}px;\n            width:${r.width}px;\n            height:${r.height}px;\n            border-radius:${i.borderRadius};\n            box-sizing:border-box;\n            padding:${i.padding};\n            background-color:${i.backgroundColor};\n            box-shadow:${i.boxShadow};\n            margin:0;\n            max-width:none;\n            max-height:none;\n            z-index:1004;\n            pointer-events:none;\n            transform-origin:top left;\n            will-change:transform,opacity;\n            transition:none;\n            transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n            opacity:1;\n            animation:none;\n          `,document.body.appendChild(e),o.innerHTML="",a.classList.remove("active"),await nextFrame(),await nextFrame(),e.style.transition=`transform 360ms ${u}, opacity 360ms ${u}`,e.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,440))),e.remove(),L.articleOriginalNode instanceof HTMLElement&&(t.replaceWith(L.articleOriginalNode),L.articleOriginalNode.style.opacity="0",L.articleOriginalNode.animate([{opacity:0},{opacity:1}],{duration:220,easing:"ease-out",fill:"forwards"}),setTimeout((()=>{L.articleOriginalNode.isConnected&&(L.articleOriginalNode.style.opacity="")}),220))}}document.documentElement.style.overflow="",L.fixedHidden&&(((e=300)=>{b=setTimeout((()=>{document.querySelectorAll(x).forEach((e=>{e.classList.remove("hide")})),b=null}),e)})(300),L.fixedHidden=!1),L.activeImg=L.activeEl=null,L.articleOriginalNode=null,L.placeholder=null,L.saved=null,L.pointers.clear(),L.pinchStart=null,L.isOpen=L.isAnimating=!1,a.style.zIndex=""}async function navigate(e){if(!L.isOpen||L.items.length<=1||L.isAnimating)return;const t=(L.currentIndex+e+L.items.length)%L.items.length;await switchToIndex(t)}async function switchToIndex(n){if(!L.isOpen||L.isAnimating)return;if(n===L.currentIndex)return;const r=L.items[n];if(!r)return;const s=n>L.currentIndex?-1:1,l=420,d=Math.round(210);L.isAnimating=!0,hideSwitcher(),a.classList.add("switching");const c=L.activeEl,m=L.placeholder,h=L.articleOriginalNode,g=L.saved,p=c.getBoundingClientRect();o.innerHTML="",c instanceof HTMLImageElement?setFlightStyles(c,p,p,v,y.borderRadius,document.body,T):setGenericFlightStyles(c,p,p,T);const w=window.innerWidth,x=window.innerHeight/2-(p.top+p.height/2),b=s<0?-(p.left+p.width+40):w-p.left+40;await nextFrame(),await nextFrame(),c.style.transition=`transform 420ms ${u}, opacity 420ms ${u}`,c.style.transform=`translate(${b}px, ${x}px) scale(0.6, 0.6)`,c.style.opacity="0",setTimeout((async()=>{if(!L.isOpen)return;L.currentIndex=n,updateSwitcher(),updateInfo();const a=getLiveNodeForItem(r),o=getNodeAspectRatio(a,r),l=a instanceof HTMLImageElement&&a.naturalWidth&&a.naturalHeight?computeViewerRect(a):computeViewerRectFromAspect(o);let d;if(L.scale=1,L.translateX=L.translateY=0,L.pointers.clear(),L.pinchStart=null,L.isDragging=!1,a instanceof HTMLImageElement){if(L.saved=saveOriginal(a),L.articleOriginalNode=a,L.placeholder=createPlaceholderForNode(a,o),a.before(L.placeholder),d=a,setFlightStyles(d,l,l,v,y.borderRadius,document.body,T),d.style.transform=s<0?`translate(${w-l.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(l.left+l.width+40)}px, 0px) scale(0.6, 0.6)`,d.style.opacity="0",await nextFrame(),d.style.transition=`transform 420ms ${u}, opacity 420ms ${u}`,d.style.opacity="1",d.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFlightStyles(d,!0),mountLoadedImgToStage(d),!d.complete||!d.naturalWidth){const e=createStagePreloader(l,o);mountPreloaderToStage(e),d.remove(),waitForImageReady(d).then((async()=>{if(L.isOpen&&L.currentIndex===n){try{await d.decode()}catch{}await nextFrame(),e.remove(),mountLoadedImgToStage(d),playPreloaderPop(d)}})).catch((()=>{setViewerPreloaderError(e,r.src)}))}}else if(a instanceof HTMLElement&&a.classList.contains("img-preloader")){const d=a.getBoundingClientRect(),c=a.classList.contains("img-preloader-error")?{left:d.left,top:d.top,width:d.width,height:d.width/o}:d;L.articleOriginalNode=a,L.saved={rect:{left:c.left,top:c.top,width:c.width,height:c.height}},L.placeholder=createPlaceholderForNode(a,o),a.replaceWith(L.placeholder);const m=createStagePreloader(l,o);setGenericFlightStyles(m,l,l,T),m.style.transform=s<0?`translate(${w-l.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(l.left+l.width+40)}px, 0px) scale(0.6, 0.6)`,m.style.opacity="0",await nextFrame(),m.style.transition=`transform 420ms ${u}, opacity 420ms ${u}`,m.style.opacity="1",m.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFixedStylesKeepStageSize(m),mountPreloaderToStage(m),e(r.src,r.alt).then((async e=>{if(!L.isOpen||L.currentIndex!==n)return;try{await e.decode()}catch{}const o=e;t(a,o),o.classList.remove("img-preloader-fade-out"),L.articleOriginalNode=o,i.add(a),m.style.position="absolute",m.style.left="50%",m.style.top="50%",m.style.transform="translate(-50%, -50%)",mountLoadedImgToStage(o,!1),playPreloaderPop(o),setTimeout((()=>{m.remove(),o.style.transition=""}),f)})).catch((()=>{setViewerPreloaderError(m,r.src)}))}const c=L.placeholder;if(c){const e=c.getBoundingClientRect().top+window.scrollY,t=Math.max(0,e-.2*window.innerHeight);try{window.scrollTo({top:t,behavior:"smooth"})}catch{window.scrollTo(0,t)}}}),d),setTimeout((()=>{h instanceof HTMLImageElement?(clearFlightStyles(c,!1),restoreOriginal(h,g),m?.replaceWith(h),h.classList.add("image-viewer-article-fade-in"),setTimeout((()=>h.classList.remove("image-viewer-article-fade-in")),260)):h instanceof HTMLElement?(c.remove(),m?.replaceWith(h),h.classList.add("image-viewer-article-fade-in"),setTimeout((()=>h.classList.remove("image-viewer-article-fade-in")),260)):c.remove()}),l),await new Promise((e=>setTimeout(e,l+d+120))),a.classList.remove("switching"),L.isAnimating=!1,scheduleShowSwitcher()}if(n.api={open:async function open(e){if(L.isOpen||L.isAnimating)return;L.isOpen=L.isAnimating=!0;const t=e instanceof HTMLElement?e.closest(".img-preloader")||e:null;L.contextRoot=(e=>{if(!e)return document;const t=e.closest?.(".markdown-body");if(t)return t;const i=e.closest?.("#shuoshuo-content");if(i)return i;const n=e.closest?.(".masonry-item");return n&&n.parentElement||document})(t),L.items=(e=>{const t=Array.from((e||document).querySelectorAll(".markdown-body img, .markdown-body .img-preloader, .masonry-item img, .masonry-item .img-preloader, #shuoshuo-content img, #shuoshuo-content .img-preloader")),i=[];return t.forEach((e=>{if(e instanceof HTMLImageElement){if(!isViewableImg(e))return;const t=e.dataset.originalSrc||e.currentSrc||e.src;i.push({kind:"img",node:e,src:String(t||""),absSrc:toAbsUrl(t),alt:e.alt||"",width:e.naturalWidth||0,height:e.naturalHeight||0})}else if(e instanceof HTMLElement&&isViewablePreloader(e)){if(e.classList.contains("img-preloader-error"))return;const t=e.dataset.src;if(!t)return;const n=Number(e.dataset.width||0),a=Number(e.dataset.height||0);i.push({kind:"preloader",node:e,src:String(t),absSrc:toAbsUrl(t),alt:e.dataset.alt||"",width:Number.isFinite(n)?n:0,height:Number.isFinite(a)?a:0})}})),i})(L.contextRoot),L.currentIndex=((e,t)=>{const i=e.findIndex((e=>e.node===t));if(i>=0)return i;if(t instanceof HTMLImageElement){const i=t.dataset.originalSrc||t.currentSrc||t.src,n=toAbsUrl(i);return e.findIndex((e=>e.absSrc===n))}const n=t?.closest?.(".img-preloader");if(n instanceof HTMLElement){const t=n.dataset.src,i=toAbsUrl(t);return e.findIndex((e=>e.absSrc===i))}return-1})(L.items,t),L.currentIndex<0||t instanceof HTMLElement&&t.classList.contains("img-preloader")&&!t.classList.contains("img-preloader-loaded")?L.isOpen=L.isAnimating=!1:(document.documentElement.style.overflow="hidden",L.fixedHidden=window.matchMedia&&window.matchMedia("(max-width: 768px), (pointer: coarse)").matches,L.fixedHidden&&(b&&(clearTimeout(b),b=null),document.querySelectorAll(x).forEach((e=>{e.classList.add("hide")}))),o.innerHTML="",a.style.zIndex="",a.classList.remove("switching"),a.classList.add("active"),hideSwitcher(),updateSwitcher(),updateInfo(),await openItemAtIndex(L.currentIndex),L.isAnimating=!1,document.addEventListener("keydown",onKeydown),L.resizeHandler||(L.resizeHandler=()=>{L.isOpen&&(L.resizeTimer&&clearTimeout(L.resizeTimer),L.resizeTimer=setTimeout((()=>{L.resizeTimer=null,updateSwitcher(),syncInfoHeight()}),120))},window.addEventListener("resize",L.resizeHandler,{passive:!0})),scheduleShowSwitcher())},close:close,isOpen:()=>L.isOpen},l.onclick=()=>navigate(-1),d.onclick=()=>navigate(1),c.onclick=()=>navigate(-1),m.onclick=()=>navigate(1),s.onclick=e=>{if(!L.isOpen||L.isAnimating)return;const t=e.target?.closest?.(".image-viewer-switcher-page");if(!(t instanceof HTMLElement))return;const i=Number(t.dataset.index||"-1");!Number.isFinite(i)||i<0||i>=L.items.length||switchToIndex(i)},h.onclick=e=>{e.stopPropagation(),!h.classList.contains("active")||h.classList.contains("closing")?(()=>{if("none"===h.style.display)return;L.infoTimer&&(clearTimeout(L.infoTimer),L.infoTimer=null),L.infoReadyTimer&&(clearTimeout(L.infoReadyTimer),L.infoReadyTimer=null);const e=measureInfoSize();h.classList.remove("closing"),h.classList.remove("info-content-ready"),h.classList.add("no-hover"),h.style.height="38px",h.style.width="38px",h.offsetWidth,h.classList.add("active"),g.style.display="block",h.style.width=`${e.w}px`,h.style.height=`${e.h}px`,L.infoStatus="opening",L.infoReadyTimer=setTimeout((()=>{h.classList.contains("active")&&(h.classList.contains("closing")||(h.classList.add("info-content-ready"),h.style.height="auto",h.style.width="fit-content",L.infoReadyTimer=null))}),360),L.infoTimer=setTimeout((()=>{L.infoStatus="open",L.infoTimer=null}),720)})():closeInfo()},g.onclick=e=>{e.stopPropagation()},n.docBound||(n.handlers.onDocClick=e=>{const t=n.api;if(!t||t.isOpen())return;const i=e.target;if(i instanceof HTMLImageElement){if(!i.matches(".markdown-body img, .masonry-item img, #shuoshuo-content img")||!isViewableImg(i))return;return void t.open(i)}const a=i?.closest?.(".img-preloader");a instanceof HTMLElement&&isViewablePreloader(a)&&a.closest(".markdown-body, .masonry-item, #shuoshuo-content")&&t.open(a)},document.addEventListener("click",n.handlers.onDocClick,!0),n.docBound=!0),n.maskEl!==a&&(n.maskEl&&n.handlers.onMaskClick&&(n.maskEl.removeEventListener("click",n.handlers.onMaskClick,!1),n.maskEl.removeEventListener("click",n.handlers.onMaskClick,!0)),n.handlers.onMaskClick=e=>{L.isOpen&&!L.isDragging&&(h.classList.contains("active")?h.contains(e.target)||closeInfo():e.target!==a&&e.target!==o||close())},a.addEventListener("click",n.handlers.onMaskClick,!0),n.maskEl=a),n.stageEl!==o){const e=n.stageEl;e&&["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((t=>{const i=n.handlers[`on${t}`];i&&e.removeEventListener(t,i,!1)})),n.handlers.onwheel=e=>{if(!L.isOpen||!L.activeImg||e.target!==L.activeImg)return;e.preventDefault();const t=L.activeImg.getBoundingClientRect(),i=e.clientX-t.left-t.width/2,n=e.clientY-t.top-t.height/2,a=L.scale;L.scale=Math.max(.5,Math.min(6,a*(e.deltaY>0?.9:1.1)));const o=L.scale/a-1;L.translateX-=i*o,L.translateY-=n*o,L.activeImg.style.transition="none",h.classList.contains("active")&&closeInfo(),applyTransform(),constrainVisible()},n.handlers.onpointerdown=e=>{L.isOpen&&L.activeImg&&e.target===L.activeImg&&(e.preventDefault(),L.activeImg.setPointerCapture(e.pointerId),L.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===L.pointers.size&&(L.dragStartX=e.clientX-L.translateX,L.dragStartY=e.clientY-L.translateY,L.activeImg.style.cursor="grabbing",L.activeImg.style.transition="none"))},n.handlers.onpointermove=e=>{if(L.isOpen&&L.activeImg&&L.pointers.has(e.pointerId)){if(L.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===L.pointers.size)return L.translateX=e.clientX-L.dragStartX,L.translateY=e.clientY-L.dragStartY,L.isDragging=!0,h.classList.contains("active")&&closeInfo(),applyTransform(),void constrainVisible();if(2===L.pointers.size){const e=Array.from(L.pointers.values()),t=Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y),i=(e[0].x+e[1].x)/2,n=(e[0].y+e[1].y)/2;L.pinchStart||(L.pinchStart={dist:t,midX:i,midY:n,scale:L.scale,tx:L.translateX,ty:L.translateY});const a=Math.max(.5,Math.min(6,L.pinchStart.scale*(t/L.pinchStart.dist))),o=a/L.scale,r=L.activeImg.getBoundingClientRect(),s=i-(r.left+r.width/2),l=n-(r.top+r.height/2);L.translateX-=s*(o-1),L.translateY-=l*(o-1),L.scale=a,L.isDragging=!0,h.classList.contains("active")&&closeInfo(),applyTransform(),constrainVisible()}}},n.handlers.onpointerup=n.handlers.onpointercancel=e=>{if(L.isOpen&&L.activeImg)if(L.pointers.delete(e.pointerId),0===L.pointers.size)L.activeImg.style.cursor="grab",L.pinchStart=null,constrainVisible(),setTimeout((()=>L.isDragging=!1),50);else if(1===L.pointers.size){L.pinchStart=null;const e=Array.from(L.pointers.values())[0];L.dragStartX=e.x-L.translateX,L.dragStartY=e.y-L.translateY}},["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((e=>{o.addEventListener(e,n.handlers[`on${e}`],{passive:!1})})),n.stageEl=o}}
//# sourceMappingURL=imageViewer.js.map